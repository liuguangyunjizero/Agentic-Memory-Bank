# Agentic Memory Bank: é¢å‘é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡çš„å±‚çº§åŒ–è®°å¿†ç®¡ç†ç³»ç»Ÿ

## ç³»ç»Ÿæ¦‚è¿°

Agentic Memory Bank æ˜¯ä¸€ä¸ªä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†é•¿ä¸Šä¸‹æ–‡åœºæ™¯çš„è®°å¿†ç®¡ç†ç³»ç»Ÿã€‚ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼ˆä»»åŠ¡çŠ¶æ€å±‚ã€è¯­ä¹‰è®°å¿†å›¾å±‚ã€äº¤äº’å†å²å±‚ï¼‰ï¼Œé…åˆå¤šä¸ªä¸“ä¸šåŒ–æ™ºèƒ½ä½“ï¼Œå®ç°å¯¹é•¿æ–‡æœ¬ã€å¤šè½®å¯¹è¯å’Œå¤æ‚æ¨ç†ä»»åŠ¡çš„ç»“æ„åŒ–ç®¡ç†ã€‚

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**å¢é‡å¼è§„åˆ’**ï¼šç³»ç»Ÿä¸é¢„å…ˆè§„åˆ’æ‰€æœ‰æ­¥éª¤ï¼Œè€Œæ˜¯æ ¹æ®å½“å‰è¿›å±•æ¯æ¬¡åªå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼Œèƒ½å¤ŸåŠ¨æ€é€‚åº”æ‰§è¡Œç»“æœå¹¶å³æ—¶å“åº”å†²çªã€‚

**å†²çªæ£€æµ‹ä¸è§£å†³**ï¼šå½“ç³»ç»Ÿå‘ç°è®°å¿†ä¸­å­˜åœ¨çŸ›ç›¾ä¿¡æ¯æ—¶ï¼Œä¼šä¸»åŠ¨è§¦å‘äº¤å‰éªŒè¯æµç¨‹ï¼Œé€šè¿‡æœç´¢æƒå¨æ¥æºæ¥è§£å†³å†²çªï¼Œæå‡è®°å¿†å¯ä¿¡åº¦ã€‚

**ä»»åŠ¡å®Œæˆå³æ¸…ç†**ï¼šç³»ç»Ÿä¸“ä¸ºå•æ¬¡ä»»åŠ¡è®¾è®¡ï¼Œæ¯æ¬¡ä»»åŠ¡å®Œæˆåæ¸…ç©ºæ‰€æœ‰è®°å¿†ï¼Œç¡®ä¿ä¸‹æ¬¡ä»»åŠ¡ä»å¹²å‡€çŠ¶æ€å¼€å§‹ã€‚ä¸åŒäºä¸ªæ€§åŒ–é•¿æœŸè®°å¿†åŠ©æ‰‹ï¼Œæœ¬ç³»ç»Ÿå…³æ³¨çš„æ˜¯å•æ¬¡ä»»åŠ¡å†…çš„é•¿ä¸Šä¸‹æ–‡ç®¡ç†ã€‚

### å…¸å‹åº”ç”¨åœºæ™¯

**æ·±åº¦ç ”ç©¶ä»»åŠ¡**ï¼šéœ€è¦ä»å¤šä¸ªæ¥æºæ”¶é›†ä¿¡æ¯ã€äº¤å‰éªŒè¯ã€è§£å†³ä¿¡æ¯å†²çªçš„ç ”ç©¶å‹ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼š"æ¯”è¾ƒåˆ†æä¸åŒæ–‡çŒ®å¯¹æŸä¸ªå†å²äº‹ä»¶çš„æè¿°ï¼Œæ‰¾å‡ºå…±è¯†å’Œåˆ†æ­§ç‚¹ã€‚"

**é•¿æ–‡æ¡£ç†è§£**ï¼šå¤„ç†è¶…å‡ºLLMå•æ¬¡ä¸Šä¸‹æ–‡çª—å£çš„é•¿æ–‡æ¡£ã€‚ä¾‹å¦‚ï¼š"è¿™ä»½50é¡µçš„æŠ€æœ¯æŠ¥å‘Šä¸»è¦è®²äº†ä»€ä¹ˆï¼Ÿç¬¬3ç« å’Œç¬¬7ç« çš„è®ºè¯é€»è¾‘æ˜¯å¦ä¸€è‡´ï¼Ÿ"

**å¤šè½®æ¨ç†ä»»åŠ¡**ï¼šéœ€è¦å¤šæ¬¡å·¥å…·è°ƒç”¨ã€å¤šæ­¥æ¨ç†çš„å¤æ‚é—®é¢˜ã€‚ä¾‹å¦‚ï¼š"è°ƒæŸ¥æŸä¸ªæŠ€æœ¯æ¡†æ¶ï¼Œå…ˆäº†è§£å®ƒçš„æ ¸å¿ƒæ¶æ„ï¼Œå†æ‰¾åˆ°ç›¸å…³å®ç°æ¡ˆä¾‹ï¼Œæœ€åæ€»ç»“æœ€ä½³å®è·µã€‚"

## å­˜å‚¨æ¶æ„

ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚åˆ†ç¦»çš„å­˜å‚¨ç»“æ„ï¼Œæ¯å±‚è´Ÿè´£ä¸åŒç²’åº¦çš„ä¿¡æ¯ç®¡ç†ã€‚

### ç¬¬ä¸€å±‚ï¼šInsight Docï¼ˆä»»åŠ¡çŠ¶æ€å±‚ï¼‰

è¿™ä¸€å±‚ç»´æŠ¤å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä½œä¸ºç³»ç»Ÿçš„"æ§åˆ¶é¢æ¿"ã€‚

**æ•°æ®ç»“æ„**ï¼š
- `doc_id`ï¼šä»»åŠ¡å”¯ä¸€æ ‡è¯†ç¬¦
- `task_goal`ï¼šç”¨æˆ·çš„åŸå§‹é—®é¢˜æˆ–ä»»åŠ¡æè¿°
- `completed_tasks`ï¼šå·²å®Œæˆçš„å­ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªå­ä»»åŠ¡åŒ…å«ï¼š
  - `type`ï¼šä»»åŠ¡ç±»å‹ï¼ˆNORMALæ™®é€šä»»åŠ¡ / CROSS_VALIDATEå†²çªéªŒè¯ä»»åŠ¡ï¼‰
  - `description`ï¼šä»»åŠ¡çš„è¯¦ç»†æè¿°
  - `status`ï¼šæ‰§è¡Œç»“æœï¼ˆsuccess / failureï¼‰
  - `context`ï¼šæµ“ç¼©çš„1-2å¥è¯æ€»ç»“
- `current_task`ï¼šå½“å‰å¾…åŠä»»åŠ¡ï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ²¡æœ‰å¾…åŠä»»åŠ¡ï¼‰

**å¢é‡å¼è§„åˆ’çš„ä½“ç°**ï¼š
ç³»ç»Ÿä¸ç»´æŠ¤ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`current_task`è¦ä¹ˆä¸ºç©ºï¼Œè¦ä¹ˆåŒ…å«å•ä¸ªä»»åŠ¡æè¿°ã€‚Planning Agentæ¯æ¬¡åªæ ¹æ®å½“å‰çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è§„åˆ’æ‰€æœ‰æ­¥éª¤ã€‚è¿™ç§è®¾è®¡è®©ç³»ç»Ÿèƒ½å¤Ÿï¼š
- æ ¹æ®æ‰§è¡Œç»“æœåŠ¨æ€è°ƒæ•´è®¡åˆ’
- åœ¨å‘ç°å†²çªæ—¶ç«‹å³æ’å…¥éªŒè¯ä»»åŠ¡
- é¿å…å¤æ‚çš„ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†

### ç¬¬äºŒå±‚ï¼šQuery Graphï¼ˆè¯­ä¹‰è®°å¿†å›¾ï¼‰

è¿™ä¸€å±‚ä»¥å›¾ç»“æ„å­˜å‚¨ç»“æ„åŒ–çš„è®°å¿†èŠ‚ç‚¹ï¼Œæ”¯æŒåŸºäºè¯­ä¹‰å’Œå…³é”®è¯çš„å¿«é€Ÿæ£€ç´¢ã€‚

**èŠ‚ç‚¹è®¾è®¡**ï¼š

æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªä¸»é¢˜èšç±»çš„å‹ç¼©è®°å¿†ï¼ŒåŒ…å«ï¼š
- `id`ï¼šèŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰
- `summary`ï¼šç»“æ„åŒ–è¯¦ç»†æ‘˜è¦ï¼ˆåŒ…å«å…³é”®ä¿¡æ¯ã€è¯æ®ã€é€»è¾‘ï¼‰
- `context`ï¼šä¸€å¥è¯ä¸»é¢˜æè¿°
- `keywords`ï¼šå…³é”®è¯åˆ—è¡¨ï¼ˆç”¨äºåŸºäºå±æ€§çš„æ£€ç´¢ï¼‰
- `embedding`ï¼šè¯­ä¹‰å‘é‡ï¼ˆç”¨äºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ï¼‰
- `timestamp`ï¼šåˆ›å»ºæ—¶é—´æˆ³
- `merge_description`ï¼šåˆå¹¶è¯´æ˜ï¼ˆä»…åˆå¹¶èŠ‚ç‚¹æœ‰å€¼ï¼‰
- `links`ï¼šç›¸å…³èŠ‚ç‚¹çš„IDåˆ—è¡¨ï¼ˆè¡¨ç¤ºrelatedè¾¹ï¼‰

**è¾¹çš„ç±»å‹**ï¼š

Query Graphåªæœ‰ä¸€ç§æ˜¾å¼çš„è¾¹ï¼š`relatedè¾¹`ï¼Œè¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´å­˜åœ¨è¯­ä¹‰ã€ä¸»é¢˜æˆ–é€»è¾‘å…³è”ã€‚

èŠ‚ç‚¹ä¹‹é—´è¿˜å¯èƒ½å­˜åœ¨`conflictå…³ç³»`ï¼Œä½†è¿™ä¸æ˜¯å›¾ä¸­çš„è¾¹ï¼Œè€Œæ˜¯ä¸€ç§ä¸´æ—¶çŠ¶æ€ã€‚å½“Memory Analysis Agentæ£€æµ‹åˆ°ä¸¤ä¸ªèŠ‚ç‚¹å†…å®¹çŸ›ç›¾æ—¶ï¼Œä¼šæ ‡è®°ä¸ºconflictå…³ç³»ï¼Œè§¦å‘äº¤å‰éªŒè¯æµç¨‹ã€‚éªŒè¯å®Œæˆåï¼Œå†²çªèŠ‚ç‚¹ä¼šè¢«åˆå¹¶æˆæ–°èŠ‚ç‚¹ï¼ŒconflictçŠ¶æ€æ¶ˆå¤±ã€‚

**æ£€ç´¢ç­–ç•¥**ï¼š

ç³»ç»Ÿé‡‡ç”¨æ··åˆæ£€ç´¢ï¼š
1. **å…³é”®è¯æ£€ç´¢**ï¼šåŸºäºBM25ç®—æ³•åŒ¹é…èŠ‚ç‚¹çš„keywordså­—æ®µ
2. **è¯­ä¹‰æ£€ç´¢**ï¼šåŸºäºä½™å¼¦ç›¸ä¼¼åº¦åŒ¹é…embeddingå‘é‡
3. **æ··åˆè®¡ç®—**ï¼šæœ€ç»ˆåˆ†æ•° = Î± Ã— å…³é”®è¯åˆ†æ•° + (1-Î±) Ã— è¯­ä¹‰åˆ†æ•°

æ£€ç´¢æµç¨‹ï¼š
1. æ ¹æ®æ··åˆåˆ†æ•°é€‰å‡ºtop-kä¸ªå€™é€‰èŠ‚ç‚¹
2. ä¸ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹é™„åŠ å…¶ä¸€è·³é‚»å±…èŠ‚ç‚¹
3. æŒ‰æ—¶é—´æˆ³é™åºæ’åˆ—æ‰€æœ‰èŠ‚ç‚¹ï¼ˆå€™é€‰èŠ‚ç‚¹+é‚»å±…èŠ‚ç‚¹ï¼‰
4. è¿”å›ç»™è°ƒç”¨æ–¹

å‚æ•°`k`ï¼ˆé»˜è®¤5ï¼‰å’Œ`Î±`ï¼ˆé»˜è®¤0.5ï¼‰å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ã€‚

### ç¬¬ä¸‰å±‚ï¼šInteraction Treeï¼ˆäº¤äº’å†å²å±‚ï¼‰

è¿™ä¸€å±‚å­˜å‚¨æ¯ä¸ªè®°å¿†èŠ‚ç‚¹çš„åŸå§‹å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒæ·±åº¦æ£€ç´¢æ—¶å›æº¯ç»†èŠ‚ã€‚

**æç®€è®¾è®¡**ï¼š

å½“å‰å®ç°é‡‡ç”¨æœ€ç®€å•çš„`{node_id: full_text}`æ˜ å°„ç»“æ„ã€‚`full_text`åŒ…å«äº†ç”Ÿæˆè¯¥è®°å¿†èŠ‚ç‚¹æ—¶çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š
- ReAct Agentçš„æ€è€ƒè¿‡ç¨‹
- å·¥å…·è°ƒç”¨åŠå…¶è¿”å›ç»“æœ
- æœ€ç»ˆå›ç­”æˆ–ç»“è®º

**ä½¿ç”¨åœºæ™¯**ï¼š

é€šå¸¸æƒ…å†µä¸‹ï¼ŒQuery Graphçš„summaryå·²ç»è¶³å¤Ÿã€‚ä½†å½“éœ€è¦æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯æ—¶ï¼ˆæ¯”å¦‚æƒ³çŸ¥é“æŸä¸ªç»“è®ºæ˜¯å¦‚ä½•æ¨å¯¼å‡ºæ¥çš„ï¼‰ï¼Œå¯ä»¥é€šè¿‡Deep Retrievalå·¥å…·è®¿é—®Interaction Treeè·å–å®Œæ•´ä¸Šä¸‹æ–‡ã€‚

**è®¾è®¡æƒè¡¡**ï¼š

æ–‡æ¡£åŸæœ¬è®¾è®¡äº†å¤æ‚çš„çˆ¶å­èŠ‚ç‚¹ç»“æ„å’Œå¤šæ¨¡æ€é™„ä»¶æ”¯æŒï¼Œä½†å½“å‰å®ç°ä¸ºäº†ç®€æ´æ€§é‡‡ç”¨äº†æ‰å¹³ç»“æ„ã€‚è¿™æ„å‘³ç€ï¼š
- ä¸æ”¯æŒå¤šæ¨¡æ€å†…å®¹ï¼ˆå›¾ç‰‡ã€PDFç­‰ï¼‰
- ä¸åŒºåˆ†æ¨ç†è¿‡ç¨‹ã€å·¥å…·è°ƒç”¨ã€å›ç­”ç­‰ä¸åŒç±»å‹çš„å†…å®¹
- æ‰€æœ‰ä¿¡æ¯éƒ½ä½œä¸ºçº¯æ–‡æœ¬å­˜å‚¨

## æ ¸å¿ƒå·¥ä½œæµç¨‹

### å¯åŠ¨é˜¶æ®µ

ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨ç³»ç»Ÿï¼š
```bash
python main.py  # å¯åŠ¨äº¤äº’æ¨¡å¼
python main.py --load memory.json  # åŠ è½½å·²æœ‰è®°å¿†åå¯åŠ¨
```

ç³»ç»Ÿæ”¯æŒä¸‰ç§è¾“å…¥æ¨¡å¼ï¼š

**æ¨¡å¼1ï¼šçº¯é—®é¢˜**
```
> What is the capital of France?
```
ç›´æ¥å›ç­”é—®é¢˜ã€‚

**æ¨¡å¼2ï¼šä»…åŠ è½½ä¸Šä¸‹æ–‡**
```
> Context: [å¤§æ®µæ–‡æœ¬å†…å®¹]
```
ç³»ç»Ÿå°†ä¸Šä¸‹æ–‡åŠ è½½åˆ°è®°å¿†ä¸­ï¼Œä¸å›ç­”é—®é¢˜ã€‚åŠ è½½è¿‡ç¨‹ä¼šï¼š
- è°ƒç”¨Classification Agentè¿›è¡Œä¸»é¢˜èšç±»
- è°ƒç”¨Structure Agentç”Ÿæˆæ‘˜è¦
- æ£€ç´¢ç›¸ä¼¼èŠ‚ç‚¹å¹¶åˆ¤æ–­å…³ç³»ï¼ˆå¯èƒ½å‘ç°å†²çªï¼‰
- åˆ›å»ºQuery GraphèŠ‚ç‚¹å’ŒInteraction Treeæ¡ç›®

å¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œç³»ç»Ÿä¼šæç¤ºç”¨æˆ·ï¼Œä½†ä¸ä¼šç«‹å³è§£å†³ï¼Œç­‰å¾…ç”¨æˆ·æé—®æ—¶å†å¤„ç†ã€‚

**æ¨¡å¼3ï¼šä¸Šä¸‹æ–‡+é—®é¢˜**
```
> Context: [å¤§æ®µæ–‡æœ¬å†…å®¹]
> Question: åŸºäºä¸Šè¿°å†…å®¹ï¼Œè¯·å›ç­”...
```
å…ˆåŠ è½½ä¸Šä¸‹æ–‡åˆ°è®°å¿†ï¼Œå†å›ç­”é—®é¢˜ã€‚

### åˆå§‹åŒ–æµç¨‹

ä»¥æ¨¡å¼3ä¸ºä¾‹ï¼Œç³»ç»Ÿçš„åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š

**1. è§£æç”¨æˆ·è¾“å…¥**
```python
text_context, question, is_context_only = _parse_user_input_simple(user_input)
```
è¯†åˆ«å‡ºä¸Šä¸‹æ–‡éƒ¨åˆ†å’Œé—®é¢˜éƒ¨åˆ†ã€‚

**2. åŠ è½½ä¸Šä¸‹æ–‡åˆ°è®°å¿†**

å¦‚æœæœ‰text_contextï¼Œç³»ç»Ÿä¼šï¼š

a) **Classification Agentåˆ†ç±»**
- è¾“å…¥ï¼šå®Œæ•´ä¸Šä¸‹æ–‡æ–‡æœ¬
- åˆ¤æ–­æ˜¯å¦éœ€è¦èšç±»ï¼ˆå¦‚æœå†…å®¹æ¶‰åŠå¤šä¸ªä¸»é¢˜ï¼‰
- å¦‚æœä¸Šä¸‹æ–‡è¶…é•¿ï¼ˆè¶…è¿‡32000 tokensï¼‰ï¼Œè‡ªåŠ¨åˆ†å—å¤„ç†
- è¾“å‡ºï¼šå¤šä¸ªclusterï¼Œæ¯ä¸ªåŒ…å«`context`ï¼ˆä¸»é¢˜æè¿°ï¼‰ã€`content`ï¼ˆåŸå§‹æ–‡æœ¬ï¼‰ã€`keywords`

b) **é€ä¸ªclusterå¤„ç†**

å¯¹æ¯ä¸ªclusterï¼š

**Structure Agent** ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦ï¼š
```python
structure_output = structure_agent.run(StructureInput(
    content=cluster.content,
    context=cluster.context,
    keywords=cluster.keywords
))
```
è¾“å‡ºï¼š`summary`ï¼ˆç»“æ„åŒ–è¯¦ç»†æ‘˜è¦ï¼‰

**ç¡¬ç¼–ç æ¨¡å—** ç»„è£…å®Œæ•´èŠ‚ç‚¹ï¼š
```python
node = QueryGraphNode(
    id=uuid.uuid4(),
    summary=structure_output.summary,
    context=cluster.context,
    keywords=cluster.keywords,
    embedding=embedding_module.compute_embedding(text),
    timestamp=time.time(),
    links=[]
)
query_graph.add_node(node)
```

**æ£€ç´¢æ¨¡å—** æŸ¥æ‰¾ç›¸ä¼¼èŠ‚ç‚¹ï¼š
```python
candidates = retrieval_module.hybrid_retrieval(
    query_embedding=node.embedding,
    query_keywords=node.keywords,
    graph=query_graph,
    exclude_ids={node.id}
)
```

**Analysis Agent** åˆ¤æ–­å…³ç³»ï¼š
```python
analysis_output = analysis_agent.run(AnalysisInput(
    new_node=NodeInfo(...),
    candidate_nodes=[NodeInfo(...) for c in candidates]
))
```
è¾“å‡ºï¼šrelationshipsåˆ—è¡¨ï¼Œæ¯ä¸ªå…³ç³»å¯èƒ½æ˜¯ï¼š
- `conflict`ï¼šå†…å®¹çŸ›ç›¾ï¼Œè®°å½•å†²çªä¿¡æ¯
- `related`ï¼šè¯­ä¹‰ç›¸å…³ï¼Œåˆ›å»ºrelatedè¾¹
- `unrelated`ï¼šæ— å…³ï¼Œä¸åšå¤„ç†

å¦‚æœå‘ç°conflictï¼Œç³»ç»Ÿä¼šè®°å½•ä½†ä¸ç«‹å³å¤„ç†ï¼ˆåœ¨context-onlyæ¨¡å¼ä¸‹ï¼‰ã€‚

**åˆ›å»ºInteraction Treeæ¡ç›®**ï¼š
```python
interaction_tree.add_entry(node.id, cluster.content)
```
ä¿å­˜åŸå§‹å®Œæ•´æ–‡æœ¬ã€‚

**3. åˆ›å»ºInsight Docå¹¶è§„åˆ’**

å¦‚æœæœ‰questionï¼Œç³»ç»Ÿä¼šåˆ›å»ºä»»åŠ¡çŠ¶æ€ï¼š
```python
insight_doc = InsightDoc(
    doc_id=uuid.uuid4(),
    task_goal=question,
    completed_tasks=[],
    current_task=""
)
```

ç„¶åè°ƒç”¨Planning Agentï¼š
```python
planning_output = planning_agent.run(PlanningInput(
    insight_doc=insight_doc
))
```

Planning Agentä¼šå†³å®šç¬¬ä¸€æ­¥è¦åšä»€ä¹ˆï¼Œæ›´æ–°`current_task`ã€‚

**4. Adapterå¢å¼ºPrompt**

æ ¹æ®å½“å‰ä»»åŠ¡ï¼ŒAdapterä¼šï¼š
- ä»Query Graphä¸­æ£€ç´¢ç›¸å…³è®°å¿†ï¼ˆæ··åˆæ£€ç´¢top-k + ä¸€è·³é‚»å±…ï¼‰
- å¦‚æœæœ‰å¾…è§£å†³çš„å†²çªï¼Œå‡†å¤‡å†²çªä¿¡æ¯
- å°†ä»»åŠ¡æè¿°ã€ç›¸å…³è®°å¿†ã€å†²çªä¿¡æ¯ç­‰ç»„åˆæˆå¢å¼ºçš„prompt
- ä¼ é€’ç»™ReAct Agentæ‰§è¡Œ

### æ‰§è¡Œå¾ªç¯

ç³»ç»Ÿè¿›å…¥å¾ªç¯ï¼Œæ¯æ¬¡è¿­ä»£åŒ…å«ï¼š

**1. ReAct Agentæ‰§è¡Œå½“å‰ä»»åŠ¡**

ReAct Agentæ˜¯ä¸€ä¸ªThink-Act-Observeå¾ªç¯ï¼š
```
[Think] æˆ‘éœ€è¦æœç´¢å…³äºXçš„ä¿¡æ¯
[Act] search("Xçš„ç›¸å…³èµ„æ–™")
[Observe] æ‰¾åˆ°äº†è¿™äº›å†…å®¹...
[Think] åŸºäºè¿™äº›ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥å›ç­”...
[Answer] æœ€ç»ˆç­”æ¡ˆæ˜¯...
```

å¯ç”¨å·¥å…·ï¼š
- `search`ï¼šä½¿ç”¨Serper APIè¿›è¡Œç½‘ç»œæœç´¢
- `visit`ï¼šä½¿ç”¨Jina Reader APIè®¿é—®ç½‘é¡µå¹¶æå–å†…å®¹
- `deep_retrieval`ï¼šä»Interaction Treeè¯»å–æŸä¸ªè®°å¿†èŠ‚ç‚¹çš„å®Œæ•´åŸå§‹ä¸Šä¸‹æ–‡

**2. Adapteræ‹¦æˆªæ‰§è¡Œç»“æœ**

å½“ReAct Agentå®Œæˆå½“å‰ä»»åŠ¡ï¼ˆè¾“å‡º`<answer>`æ ‡ç­¾æˆ–è¾¾åˆ°åœæ­¢æ¡ä»¶ï¼‰ï¼ŒAdapterä¼šæ‹¦æˆªå®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬æ‰€æœ‰thinkã€tool callã€observeã€answerç­‰ï¼‰ã€‚

**3. åˆ¤æ–­ä»»åŠ¡ç±»å‹å¹¶æ›´æ–°è®°å¿†**

Adapteræ ¹æ®å½“å‰ä»»åŠ¡ç±»å‹å†³å®šå¦‚ä½•å¤„ç†ï¼š

**æƒ…å†µAï¼šæ™®é€šä»»åŠ¡ï¼ˆNORMALï¼‰**

é‡å¤åˆå§‹åŒ–æ—¶çš„æµç¨‹ï¼šClassification â†’ Structure â†’ æ£€ç´¢ â†’ Analysis â†’ å»ºè¾¹ â†’ åˆ›å»ºInteraction Treeæ¡ç›®ã€‚

æ–°ç”Ÿæˆçš„è®°å¿†èŠ‚ç‚¹ä¼šè¢«ä¼ é€’ç»™Planning Agentã€‚

**æƒ…å†µBï¼šå†²çªéªŒè¯ä»»åŠ¡ï¼ˆCROSS_VALIDATEï¼‰**

å¦‚æœå½“å‰ä»»åŠ¡æ˜¯è§£å†³ä¹‹å‰å‘ç°çš„å†²çªï¼ŒAdapterä¼šç›´æ¥è°ƒç”¨Integration Agentï¼š
```python
integration_output = integration_agent.run(IntegrationInput(
    nodes_to_merge=[...],  # å†²çªçš„èŠ‚ç‚¹åˆ—è¡¨
    verification_result=react_result  # ReActçš„éªŒè¯ç»“æœ
))
```

Integration Agentä¼šï¼š
- åŸºäºéªŒè¯ç»“æœå†³å®šå¦‚ä½•æ•´åˆå†²çªèŠ‚ç‚¹
- ç”Ÿæˆæ–°çš„`summary`ã€`context`ã€`keywords`
- æä¾›`merge_description`è¯´æ˜åˆå¹¶è¿‡ç¨‹

ç¡¬ç¼–ç æ¨¡å—ä¼šï¼š
- åˆ›å»ºæ–°çš„åˆå¹¶èŠ‚ç‚¹
- åˆ é™¤æ—§çš„å†²çªèŠ‚ç‚¹
- ç»§æ‰¿æ‰€æœ‰å†²çªèŠ‚ç‚¹çš„è¾¹ï¼ˆå»é‡ï¼‰
- æ›´æ–°é‚»å±…èŠ‚ç‚¹çš„è¿æ¥

**é˜²æ­¢æ— é™åˆå¹¶**ï¼šç³»ç»Ÿæœ‰`MAX_MERGE_DEPTH`é™åˆ¶ï¼ˆé»˜è®¤3ï¼‰ï¼Œé˜²æ­¢é€’å½’åˆå¹¶æ·±åº¦è¿‡å¤§ã€‚

**4. Planning Agentæ›´æ–°è®¡åˆ’**

Planning Agentæ¥æ”¶ï¼š
- å½“å‰çš„Insight Doc
- æ–°ç”Ÿæˆçš„è®°å¿†èŠ‚ç‚¹ä¿¡æ¯
- å¯èƒ½çš„å†²çªé€šçŸ¥

Planning Agentä¼šï¼š
- å°†åˆšå®Œæˆçš„ä»»åŠ¡æ·»åŠ åˆ°`completed_tasks`
- åˆ†ææ–°çš„è®°å¿†å’Œå†²çªæƒ…å†µ
- å†³å®šä¸‹ä¸€æ­¥è¦åšä»€ä¹ˆï¼ˆæ›´æ–°`current_task`ï¼‰
- å¦‚æœä»»åŠ¡å®Œæˆï¼Œå°†`current_task`è®¾ä¸ºç©ºå­—ç¬¦ä¸²

**5. ç»ˆæ­¢åˆ¤æ–­**

å¦‚æœ`current_task`ä¸ºç©ºï¼Œç³»ç»Ÿç»ˆæ­¢ã€‚å¦åˆ™å›åˆ°æ­¥éª¤1ï¼ŒAdapteré‡æ–°å¢å¼ºpromptè¿›è¡Œä¸‹ä¸€è½®ã€‚

### å†²çªå¤„ç†æœºåˆ¶

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç”¨äºå¤„ç†çŸ›ç›¾ä¿¡æ¯ã€‚

**è§¦å‘æ—¶æœº**ï¼š

å½“Memory Analysis Agentåœ¨åˆ¤æ–­æ–°èŠ‚ç‚¹ä¸å·²æœ‰èŠ‚ç‚¹çš„å…³ç³»æ—¶ï¼Œå¦‚æœå‘ç°å†…å®¹çŸ›ç›¾ï¼Œä¼šæ ‡è®°ä¸ºconflictå…³ç³»ã€‚

**å¤„ç†æµç¨‹**ï¼š

1. **æ ‡è®°å†²çª**ï¼šè®°å½•å†²çªçš„èŠ‚ç‚¹IDå’Œå†²çªæè¿°ï¼Œä½†æš‚æ—¶ä¸åšå¤„ç†

2. **é€šçŸ¥Planning Agent**ï¼šå°†å†²çªä¿¡æ¯ä¼ é€’ç»™Planning Agent

3. **è§„åˆ’éªŒè¯ä»»åŠ¡**ï¼šPlanning Agentä¼šå°†ä¸‹ä¸€ä¸ªä»»åŠ¡è®¾ä¸ºCROSS_VALIDATEç±»å‹ï¼Œä»»åŠ¡æè¿°åŒ…å«ï¼š
   - å“ªäº›èŠ‚ç‚¹å­˜åœ¨å†²çª
   - å†²çªçš„å†…å®¹æ˜¯ä»€ä¹ˆ
   - éœ€è¦éªŒè¯ä»€ä¹ˆ

4. **ReActæ‰§è¡ŒéªŒè¯**ï¼šåœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­ï¼ŒReAct Agentä¼šï¼š
   - è°ƒç”¨searchå·¥å…·æœç´¢æƒå¨æ¥æº
   - å¯èƒ½è®¿é—®å¤šä¸ªç½‘é¡µè¿›è¡Œäº¤å‰éªŒè¯
   - å¾—å‡ºéªŒè¯ç»“è®º

5. **Integration Agentæ•´åˆ**ï¼šåŸºäºéªŒè¯ç»“æœï¼ŒIntegration Agentä¼šï¼š
   - åˆ†æå“ªäº›ä¿¡æ¯æ˜¯å‡†ç¡®çš„
   - ç»¼åˆå¤šæ–¹ä¿¡æ¯ç”Ÿæˆæ–°çš„æ‘˜è¦
   - ç”Ÿæˆåˆå¹¶åçš„èŠ‚ç‚¹

6. **é€’å½’æ£€æµ‹**ï¼šåˆå¹¶åçš„æ–°èŠ‚ç‚¹ä¼šå†æ¬¡è¿›å…¥æ£€ç´¢å’Œå…³ç³»åˆ¤æ–­æµç¨‹ï¼Œå¦‚æœåˆå‘ç°æ–°çš„å†²çªï¼Œä¼šç»§ç»­å¤„ç†ï¼Œç›´åˆ°è¾¾åˆ°`MAX_MERGE_DEPTH`é™åˆ¶ã€‚

**ç¤ºä¾‹åœºæ™¯**ï¼š

å‡è®¾è®°å¿†ä¸­å·²æœ‰èŠ‚ç‚¹Aï¼š"åŸƒè²å°”é“å¡”é«˜324ç±³"ã€‚ç°åœ¨åŠ è½½æ–°ä¸Šä¸‹æ–‡ç”ŸæˆèŠ‚ç‚¹Bï¼š"åŸƒè²å°”é“å¡”é«˜330ç±³"ã€‚

1. Analysis Agentæ£€æµ‹åˆ°å†²çª
2. Planning Agentè§„åˆ’ï¼šéªŒè¯åŸƒè²å°”é“å¡”çš„å‡†ç¡®é«˜åº¦
3. ReAct Agentæœç´¢å®˜æ–¹èµ„æ–™ï¼Œå‘ç°ï¼šé“å¡”æœ¬ä½“324ç±³ï¼ŒåŠ ä¸Šå¤©çº¿æ€»é«˜330ç±³
4. Integration Agentæ•´åˆï¼š"åŸƒè²å°”é“å¡”æœ¬ä½“é«˜324ç±³ï¼ŒåŒ…å«å¤©çº¿æ€»é«˜330ç±³"

## Agentè¯¦ç»†è®¾è®¡

### Classification Agentï¼ˆåˆ†ç±»æ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šå¯¹é•¿ä¸Šä¸‹æ–‡è¿›è¡Œä¸»é¢˜åˆ†ç±»æˆ–èšç±»ã€‚

**è¾“å…¥**ï¼š
- `context`ï¼šé•¿ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼ˆå¯èƒ½è¶…é•¿ï¼‰
- `task_goal`ï¼šæ€»ä»»åŠ¡ç›®æ ‡ï¼ˆå¯é€‰ï¼Œç”¨äºè¾…åŠ©åˆ¤æ–­ï¼‰
- `current_task`ï¼šå½“å‰å­ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

**å¤„ç†ç­–ç•¥**ï¼š

æ­£å¸¸æƒ…å†µï¼ˆä¸è¶…é•¿ï¼‰ï¼š
```
è¾“å…¥ï¼šä¸Šä¸‹æ–‡æ–‡æœ¬
â†“
LLMè°ƒç”¨
â†“
è¾“å‡ºï¼šæ˜¯å¦éœ€è¦èšç±» + èšç±»åˆ—è¡¨
```

è¶…é•¿æƒ…å†µï¼ˆè¶…è¿‡32000 tokensï¼‰ï¼š
```
è¾“å…¥ï¼šè¶…é•¿ä¸Šä¸‹æ–‡
â†“
æŒ‰æ®µè½è¾¹ç•Œåˆ†å—ï¼ˆæ¯å—çº¦90%çª—å£å¤§å°ï¼‰
â†“
æ¯å—ç‹¬ç«‹è°ƒç”¨LLM
â†“
åˆå¹¶æ‰€æœ‰å—çš„èšç±»ç»“æœ
```

**è¾“å‡ºæ ¼å¼**ï¼ˆéJSONï¼Œä½¿ç”¨ç‰¹æ®Šåˆ†éš”ç¬¦ï¼‰ï¼š
```
SHOULD_CLUSTER: true

=== CLUSTER c1 ===
CONTEXT: ä¸»é¢˜æè¿°
KEYWORDS: å…³é”®è¯1, å…³é”®è¯2, å…³é”®è¯3
CONTENT_START
åŸå§‹æ–‡æœ¬å†…å®¹
CONTENT_END

=== CLUSTER c2 ===
...
```

**LLMå‚æ•°**ï¼štemperature=0.4, top_p=0.9ï¼ˆé€‚ä¸­çš„åˆ›é€ æ€§ï¼‰

### Structure Agentï¼ˆç»“æ„åŒ–æ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šå°†å•ä¸ªèšç±»å†…å®¹å‹ç¼©ä¸ºç»“æ„åŒ–æ‘˜è¦ã€‚

**è¾“å…¥**ï¼š
- `content`ï¼šå•ä¸ªclusterçš„æ–‡æœ¬å†…å®¹
- `context`ï¼šclusterçš„ä¸»é¢˜æè¿°
- `keywords`ï¼šclusterçš„å…³é”®è¯

**å¤„ç†é€»è¾‘**ï¼š

è°ƒç”¨LLMè¿›è¡Œå‹ç¼©æ€»ç»“ï¼Œè¦æ±‚ï¼š
- ä¿ç•™å…³é”®ä¿¡æ¯å’Œè¯æ®
- ä¿æŒé€»è¾‘æ¸…æ™°
- é€‚åº¦å‹ç¼©ï¼ˆä¸è¦ä¸¢å¤±é‡è¦ç»†èŠ‚ï¼‰

**è¾“å‡º**ï¼š
- `summary`ï¼šç»“æ„åŒ–è¯¦ç»†æ‘˜è¦

**LLMå‚æ•°**ï¼štemperature=0.1, top_p=0.8ï¼ˆä½æ¸©åº¦ï¼Œç¡®ä¿è¾“å‡ºç²¾ç¡®å¯æ§ï¼‰

### Memory Analysis Agentï¼ˆè®°å¿†åˆ†ææ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šåˆ¤æ–­æ–°èŠ‚ç‚¹ä¸å·²æœ‰èŠ‚ç‚¹çš„å…³ç³»ã€‚

**è¾“å…¥**ï¼š
- `new_node`ï¼šæ–°ç”Ÿæˆçš„èŠ‚ç‚¹ï¼ˆåŒ…å«summary, context, keywordsï¼Œä½†ä¸åŒ…å«embeddingï¼‰
- `candidate_nodes`ï¼šæ£€ç´¢æ¨¡å—è¿”å›çš„å€™é€‰èŠ‚ç‚¹åˆ—è¡¨

**åˆ¤æ–­ç­–ç•¥**ï¼š

ç³»ç»Ÿé‡‡ç”¨ä¼˜å…ˆçº§æœºåˆ¶ï¼šconflict > related > unrelated

LLMä¼šé€ä¸ªæ£€æŸ¥å€™é€‰èŠ‚ç‚¹ï¼š
1. å…ˆåˆ¤æ–­æ˜¯å¦conflictï¼ˆå†…å®¹çŸ›ç›¾ï¼‰
2. å¦‚æœä¸æ˜¯conflictï¼Œåˆ¤æ–­æ˜¯å¦relatedï¼ˆè¯­ä¹‰ç›¸å…³ï¼‰
3. å¦‚æœéƒ½ä¸æ˜¯ï¼Œæ ‡è®°ä¸ºunrelated

**è¾“å‡º**ï¼š
```json
{
  "relationships": [
    {
      "existing_node_id": "uuid-xxx",
      "relationship": "conflict",
      "conflict_description": "å…³äºXçš„æè¿°å­˜åœ¨çŸ›ç›¾",
      "reasoning": "èŠ‚ç‚¹Aè¯´..., èŠ‚ç‚¹Bè¯´..."
    },
    {
      "existing_node_id": "uuid-yyy",
      "relationship": "related",
      "reasoning": "éƒ½è®¨è®ºäº†Yä¸»é¢˜"
    }
  ]
}
```

**LLMå‚æ•°**ï¼štemperature=0.4, top_p=0.9

### Integration Agentï¼ˆæ•´åˆæ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šåˆå¹¶å†²çªèŠ‚ç‚¹ç”Ÿæˆæ–°èŠ‚ç‚¹ã€‚

**è¾“å…¥**ï¼š
- `nodes_to_merge`ï¼šéœ€è¦åˆå¹¶çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ˆé€šå¸¸æ˜¯å†²çªçš„èŠ‚ç‚¹ï¼‰
- `nodes_neighbors`ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…ä¿¡æ¯
- `verification_result`ï¼šReAct Agentçš„éªŒè¯ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰

**å¤„ç†é€»è¾‘**ï¼š

åŸºäºé¢„å®šä¹‰çš„åˆå¹¶ç­–ç•¥ï¼š
- ä¼˜å…ˆé‡‡çº³æ›´æ–°çš„ä¿¡æ¯ï¼ˆåŸºäºtimestampï¼‰
- ç»¼åˆæ‰€æœ‰èŠ‚ç‚¹çš„ä¼˜åŠ¿
- ä½¿ç”¨éªŒè¯ç»“æœä½œä¸ºæƒå¨

**è¾“å‡º**ï¼š
```json
{
  "merged_summary": "æ•´åˆåçš„æ‘˜è¦",
  "merged_context": "æ•´åˆåçš„ä¸»é¢˜æè¿°",
  "merged_keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
  "merge_description": "è¯´æ˜åˆå¹¶è¿‡ç¨‹å’Œç†ç”±"
}
```

**åç»­ç¡¬ç¼–ç å¤„ç†**ï¼š
- ç”Ÿæˆæ–°èŠ‚ç‚¹çš„embedding
- ç»§æ‰¿æ‰€æœ‰è¢«åˆå¹¶èŠ‚ç‚¹çš„è¾¹ï¼ˆå»é‡ï¼‰
- åˆ é™¤æ—§èŠ‚ç‚¹
- æ›´æ–°Interaction Treeï¼ˆæ·»åŠ åˆå¹¶äº‹ä»¶è®°å½•ï¼‰

**LLMå‚æ•°**ï¼štemperature=0.2, top_p=0.85ï¼ˆä½æ¸©åº¦ï¼Œç¡®ä¿æ•´åˆçš„ä¸€è‡´æ€§ï¼‰

### Planning Agentï¼ˆè§„åˆ’æ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šåˆ†æå½“å‰çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚

**è¾“å…¥**ï¼š
- `insight_doc`ï¼šå½“å‰ä»»åŠ¡çŠ¶æ€
- `new_memory_nodes`ï¼šæ–°ç”Ÿæˆçš„è®°å¿†èŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
- `conflict_notification`ï¼šå†²çªé€šçŸ¥ï¼ˆå¦‚æœæœ‰ï¼‰

**è§„åˆ’ç­–ç•¥**ï¼š

**å¢é‡å¼è§„åˆ’**ï¼šåªå†³å®šä¸‹ä¸€æ­¥ï¼Œä¸é¢„å…ˆè§„åˆ’æ‰€æœ‰æ­¥éª¤ã€‚

**å†³ç­–é€»è¾‘**ï¼š
1. å¦‚æœæœ‰æœªè§£å†³çš„å†²çª â†’ è§„åˆ’CROSS_VALIDATEä»»åŠ¡
2. å¦‚æœä»»åŠ¡ç›®æ ‡æœªè¾¾æˆ â†’ è§„åˆ’NORMALä»»åŠ¡ç»§ç»­æ¨è¿›
3. å¦‚æœä»»åŠ¡å®Œæˆ â†’ å°†`current_task`è®¾ä¸ºç©ºå­—ç¬¦ä¸²

**è¾“å‡º**ï¼š
```json
{
  "task_goal": "åŸå§‹ä»»åŠ¡ç›®æ ‡",
  "completed_tasks": [
    {
      "type": "NORMAL",
      "description": "å·²å®Œæˆçš„ä»»åŠ¡æè¿°",
      "status": "success",
      "context": "æµ“ç¼©æ€»ç»“"
    }
  ],
  "current_task": "ä¸‹ä¸€æ­¥è¦åšçš„ä»»åŠ¡"
}
```

**ç»ˆæ­¢åˆ¤æ–­**ï¼š

å½“`current_task`ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œç³»ç»Ÿè®¤ä¸ºä»»åŠ¡å®Œæˆï¼Œåœæ­¢æ‰§è¡Œã€‚

**LLMå‚æ•°**ï¼štemperature=0.6, top_p=0.95ï¼ˆè¾ƒé«˜æ¸©åº¦ï¼Œå…è®¸çµæ´»è§„åˆ’ï¼‰

### ReAct Agentï¼ˆæ¨ç†-è¡ŒåŠ¨æ™ºèƒ½ä½“ï¼‰

**èŒè´£**ï¼šæ‰§è¡Œå…·ä½“ä»»åŠ¡ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨å’Œå¤šè½®æ¨ç†ã€‚

**æ ¸å¿ƒå¾ªç¯**ï¼šThink â†’ Act â†’ Observe â†’ é‡å¤ï¼Œç›´åˆ°å¾—å‡ºAnswerã€‚

**å¯ç”¨å·¥å…·**ï¼š

1. **search(query)**ï¼šç½‘ç»œæœç´¢
   - ä½¿ç”¨Serper API
   - è¿”å›æœç´¢ç»“æœçš„æ ‡é¢˜ã€é“¾æ¥ã€æ‘˜è¦

2. **visit(url)**ï¼šè®¿é—®ç½‘é¡µ
   - ä½¿ç”¨Jina Reader API
   - è¿”å›ç½‘é¡µçš„æ¸…æ´æ–‡æœ¬å†…å®¹

3. **deep_retrieval(node_id)**ï¼šæ·±åº¦æ£€ç´¢
   - ä»Interaction Treeè¯»å–æŒ‡å®šèŠ‚ç‚¹çš„å®Œæ•´åŸå§‹ä¸Šä¸‹æ–‡
   - ç”¨äºéœ€è¦å›æº¯è¯¦ç»†ä¿¡æ¯çš„åœºæ™¯

**æ ‡ç­¾æ ¼å¼**ï¼š
```xml
<think>æˆ‘éœ€è¦å…ˆæœç´¢ç›¸å…³ä¿¡æ¯</think>
<tool_call>{"tool_name": "search", "arguments": {"query": "..."}}</tool_call>
<!-- ç³»ç»Ÿè¿”å› -->
<tool_response>æœç´¢ç»“æœ...</tool_response>
<think>åŸºäºæœç´¢ç»“æœï¼Œæˆ‘å¯ä»¥å¾—å‡ºç»“è®º</think>
<answer>æœ€ç»ˆç­”æ¡ˆ</answer>
```

**ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š

ReAct Agentç»´æŠ¤å®Œæ•´çš„æ¶ˆæ¯å†å²ï¼ŒæŒç»­è¿½è¸ªtokenæ•°é‡ã€‚å½“æ¥è¿‘`MAX_CONTEXT_TOKENS`é™åˆ¶æ—¶ï¼Œä¼šæç¤ºLLMå°½å¿«ç»™å‡ºç­”æ¡ˆã€‚

**ç»ˆæ­¢æ¡ä»¶**ï¼š
- å‡ºç°`<answer>`æ ‡ç­¾
- è¾¾åˆ°`MAX_LLM_CALL_PER_RUN`é™åˆ¶
- è¶…è¿‡`MAX_CONTEXT_TOKENS`é™åˆ¶
- å‘ç”Ÿä¸¥é‡é”™è¯¯

**LLMå‚æ•°**ï¼štemperature=0.6, top_p=0.95

## æ¥å£å±‚è®¾è®¡

### MemoryBankAdapter

è¿™æ˜¯Memory Bankä¸ReAct Agentä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£ï¼š

**1. Promptå¢å¼º**

åœ¨æ¯è½®æ‰§è¡Œå‰ï¼ŒAdapterä¼šï¼š
```python
def enhance_prompt(insight_doc):
    # 1. è¯»å–å½“å‰ä»»åŠ¡
    current_task = insight_doc.current_task

    # 2. æ£€ç´¢ç›¸å…³è®°å¿†
    relevant_memories = retrieval_module.hybrid_retrieval(
        query_text=current_task,
        k=5
    )

    # 3. æ£€æŸ¥æ˜¯å¦æœ‰å¾…è§£å†³çš„å†²çª
    pending_conflicts = self._get_pending_conflicts()

    # 4. ç»„è£…å¢å¼ºprompt
    prompt = f"""
<task>
Task Goal: {insight_doc.task_goal}
Current Subtask: {current_task}
Completed Tasks: {format_completed_tasks(insight_doc.completed_tasks)}
</task>

<memory>
Relevant memories:
{format_memories(relevant_memories)}
</memory>

{format_conflicts(pending_conflicts) if pending_conflicts else ""}

Please execute the current subtask.
"""
    return prompt
```

**2. ä¸Šä¸‹æ–‡æ‹¦æˆª**

åœ¨æ¯è½®æ‰§è¡Œåï¼ŒAdapterä¼šï¼š
```python
def intercept_context(full_context, task_type, insight_doc):
    if task_type == "CROSS_VALIDATE":
        # å†²çªéªŒè¯ä»»åŠ¡ â†’ Integration Agent
        self._handle_conflict_resolution(full_context)
    else:
        # æ™®é€šä»»åŠ¡ â†’ æ­£å¸¸è®°å¿†æ›´æ–°æµç¨‹
        self._handle_normal_task(full_context)
```

**3. å†²çªç®¡ç†**

Adapterç»´æŠ¤ä¸€ä¸ªå†…éƒ¨çš„å†²çªé˜Ÿåˆ—ï¼š
```python
self._pending_conflicts = []  # å¾…è§£å†³çš„å†²çªåˆ—è¡¨
```

å½“Analysis Agentæ£€æµ‹åˆ°å†²çªæ—¶ï¼Œä¼šåŠ å…¥è¿™ä¸ªé˜Ÿåˆ—ã€‚å½“Planning Agentè§„åˆ’éªŒè¯ä»»åŠ¡åï¼Œå†²çªä¼šè¢«æ ‡è®°ä¸º"å¤„ç†ä¸­"ã€‚éªŒè¯å®Œæˆåï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚

### Deep Retrieval Tool

ä¾›ReAct Agentè°ƒç”¨çš„å·¥å…·ï¼Œç”¨äºè®¿é—®Interaction Treeçš„å®Œæ•´å†…å®¹ã€‚

**å®ç°**ï¼š
```python
class DeepRetrievalTool:
    def __call__(self, node_id: str) -> str:
        # ä»Interaction Treeè¯»å–å®Œæ•´æ–‡æœ¬
        full_text = self.interaction_tree.get_entry(node_id)

        if not full_text:
            return f"Node {node_id} not found in Interaction Tree"

        # è¿”å›æ ¼å¼åŒ–çš„å®Œæ•´å†…å®¹
        return f"""
=== Deep Retrieval Result ===
Node ID: {node_id}
Full Context:
{full_text}
===========================
"""
```

**ä½¿ç”¨åœºæ™¯ç¤ºä¾‹**ï¼š

```xml
<think>Memoryä¸­æåˆ°"Xç†è®ºçš„æ ¸å¿ƒæ€æƒ³"ï¼Œä½†æ‘˜è¦ä¸å¤Ÿè¯¦ç»†ï¼Œæˆ‘éœ€è¦æŸ¥çœ‹å®Œæ•´å†…å®¹</think>
<tool_call>{"tool_name": "deep_retrieval", "arguments": {"node_id": "uuid-xxx"}}</tool_call>
```

## ç¡¬ç¼–ç æ¨¡å—

è¿™äº›æ¨¡å—ä¸æ¶‰åŠLLMè°ƒç”¨ï¼Œé€šè¿‡ç¨‹åºé€»è¾‘å®ç°ã€‚

### Embedding Module

**èŒè´£**ï¼šä¸ºæ–‡æœ¬ç”Ÿæˆè¯­ä¹‰å‘é‡ã€‚

**å®ç°**ï¼šä½¿ç”¨sentence-transformersåº“
```python
from sentence_transformers import SentenceTransformer

class EmbeddingModule:
    def __init__(self, model_name="all-MiniLM-L6-v2"):
        self.model = SentenceTransformer(model_name)

    def compute_embedding(self, text: str) -> np.ndarray:
        return self.model.encode(text)
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ›å»ºæ–°èŠ‚ç‚¹æ—¶ï¼Œä¸º`summary + context + keywords`ç”Ÿæˆembedding
- æ£€ç´¢æ—¶ï¼Œä¸ºqueryç”Ÿæˆembeddingè¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—

### Retrieval Module

**èŒè´£**ï¼šåŸºäºembeddingå’Œå…³é”®è¯æ£€ç´¢ç›¸ä¼¼èŠ‚ç‚¹ã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
def hybrid_retrieval(
    query_embedding: np.ndarray,
    query_keywords: List[str],
    graph: QueryGraph,
    k: int = 5,
    alpha: float = 0.5,
    exclude_ids: Set[str] = None
) -> List[QueryGraphNode]:
    # 1. BM25å…³é”®è¯æ£€ç´¢
    keyword_scores = self._bm25_search(query_keywords)

    # 2. è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
    semantic_scores = self._cosine_similarity(query_embedding)

    # 3. æ··åˆåˆ†æ•°
    final_scores = alpha * keyword_scores + (1-alpha) * semantic_scores

    # 4. é€‰å‡ºtop-k
    candidates = select_topk(final_scores, k, exclude_ids)

    # 5. ä¸ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹é™„åŠ ä¸€è·³é‚»å±…
    results_with_neighbors = []
    for node in candidates:
        results_with_neighbors.append(node)
        results_with_neighbors.extend(graph.get_neighbors(node.id))

    # 6. å»é‡å¹¶æŒ‰æ—¶é—´æˆ³æ’åº
    unique_results = remove_duplicates(results_with_neighbors)
    sorted_results = sort_by_timestamp(unique_results, descending=True)

    return sorted_results
```

**ç´¢å¼•ç®¡ç†**ï¼š

ç³»ç»Ÿç»´æŠ¤BM25ç´¢å¼•ç”¨äºå…³é”®è¯æ£€ç´¢ã€‚å½“å›¾ç»“æ„å‘ç”Ÿå˜åŒ–ï¼ˆæ·»åŠ /åˆ é™¤/æ›´æ–°èŠ‚ç‚¹ï¼‰æ—¶ï¼Œç´¢å¼•è¢«æ ‡è®°ä¸º"è„"ã€‚ä¸‹æ¬¡æ£€ç´¢æ—¶ä¼šè‡ªåŠ¨é‡å»ºç´¢å¼•ã€‚

### Graph Operations Module

**èŒè´£**ï¼šç®¡ç†Query Graphçš„èŠ‚ç‚¹å’Œè¾¹æ“ä½œã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class GraphOperations:
    def __init__(self, query_graph, interaction_tree):
        self.query_graph = query_graph
        self.interaction_tree = interaction_tree

    def add_node(self, node):
        """æ·»åŠ èŠ‚ç‚¹åˆ°å›¾"""
        self.query_graph.add_node(node)

    def add_edge(self, node_id1, node_id2):
        """åˆ›å»ºrelatedè¾¹"""
        self.query_graph.add_edge(node_id1, node_id2)

    def merge_nodes(self, node_ids, merged_node):
        """åˆå¹¶å¤šä¸ªèŠ‚ç‚¹"""
        # 1. æ”¶é›†æ‰€æœ‰è¢«åˆå¹¶èŠ‚ç‚¹çš„é‚»å±…
        all_neighbors = set()
        for nid in node_ids:
            neighbors = self.query_graph.get_neighbors(nid)
            all_neighbors.update(n.id for n in neighbors)

        # 2. æ·»åŠ æ–°èŠ‚ç‚¹
        self.query_graph.add_node(merged_node)

        # 3. ç»§æ‰¿æ‰€æœ‰è¾¹ï¼ˆå»é‡ï¼‰
        for neighbor_id in all_neighbors:
            if neighbor_id not in node_ids:  # æ’é™¤è¢«åˆå¹¶çš„èŠ‚ç‚¹
                self.query_graph.add_edge(merged_node.id, neighbor_id)

        # 4. åˆ é™¤æ—§èŠ‚ç‚¹
        for nid in node_ids:
            self.query_graph.delete_node(nid)
            # Interaction Treeæ¡ç›®ä¿ç•™ï¼Œé‡æ–°é™„åŠ åˆ°æ–°èŠ‚ç‚¹
```

**å®ç°ç»†èŠ‚**ï¼š

Query Graphä½¿ç”¨è‡ªå®šä¹‰é‚»æ¥è¡¨å®ç°ï¼ˆä¸ä¾èµ–NetworkXï¼‰ï¼š
```python
class QueryGraph:
    def __init__(self):
        self.nodes_dict = {}  # {node_id: QueryGraphNode}

    # æ¯ä¸ªèŠ‚ç‚¹çš„linksåˆ—è¡¨å­˜å‚¨é‚»å±…ID
    # è¾¹æ˜¯æ— å‘çš„ï¼Œæ‰€ä»¥éœ€è¦åŒå‘ç»´æŠ¤
```

## ç³»ç»Ÿç‰¹æ€§

### å¯é…ç½®çš„LLMå‚æ•°

æ¯ä¸ªAgentå¯ä»¥ç‹¬ç«‹é…ç½®temperatureå’Œtop_pï¼Œé’ˆå¯¹ä¸åŒä»»åŠ¡ä¼˜åŒ–ï¼š

| Agent | Temperature | Top-P | è¯´æ˜ |
|-------|-------------|-------|------|
| Classification | 0.4 | 0.9 | éœ€è¦ä¸€å®šåˆ›é€ æ€§æ¥è¯†åˆ«ä¸»é¢˜ |
| Structure | 0.1 | 0.8 | éœ€è¦ç²¾ç¡®çš„å‹ç¼©å’Œç»“æ„åŒ– |
| Analysis | 0.4 | 0.9 | éœ€è¦å‡†ç¡®åˆ¤æ–­å…³ç³» |
| Integration | 0.2 | 0.85 | éœ€è¦ç¨³å®šä¸€è‡´çš„æ•´åˆ |
| Planning | 0.6 | 0.95 | éœ€è¦çµæ´»çš„è§„åˆ’èƒ½åŠ› |
| ReAct | 0.6 | 0.95 | éœ€è¦åˆ›é€ æ€§æ¨ç† |

### æ··åˆæ£€ç´¢ç­–ç•¥

ç³»ç»Ÿç»“åˆå…³é”®è¯å’Œè¯­ä¹‰ä¸¤ç§æ£€ç´¢æ–¹å¼ï¼š

**å…³é”®è¯æ£€ç´¢**ï¼šé€‚åˆç²¾ç¡®åŒ¹é…åœºæ™¯
- ç”¨æˆ·é—®ï¼š"åŸƒè²å°”é“å¡”çš„é«˜åº¦"
- å…³é”®è¯["åŸƒè²å°”é“å¡”", "é«˜åº¦"]ç²¾ç¡®åŒ¹é…ç›¸å…³èŠ‚ç‚¹

**è¯­ä¹‰æ£€ç´¢**ï¼šé€‚åˆæ¦‚å¿µç›¸ä¼¼åœºæ™¯
- ç”¨æˆ·é—®ï¼š"å·´é»çš„æ ‡å¿—æ€§å»ºç­‘"
- è™½ç„¶æ²¡æœ‰ç›´æ¥æåˆ°"åŸƒè²å°”é“å¡”"ï¼Œä½†è¯­ä¹‰ç›¸è¿‘

**æ··åˆæ£€ç´¢**ï¼šå¹³è¡¡ä¸¤è€…
- `Î±=0.5`ï¼šå‡è¡¡æƒé‡
- `Î±=0.7`ï¼šåå‘å…³é”®è¯ï¼ˆç²¾ç¡®æ€§ï¼‰
- `Î±=0.3`ï¼šåå‘è¯­ä¹‰ï¼ˆå¬å›ç‡ï¼‰

### é‚»å±…æ‰©å±•æœºåˆ¶

æ£€ç´¢ä¸ä»…è¿”å›top-kå€™é€‰èŠ‚ç‚¹ï¼Œè¿˜åŒ…æ‹¬æ¯ä¸ªå€™é€‰èŠ‚ç‚¹çš„ä¸€è·³é‚»å±…ã€‚è¿™æä¾›äº†æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ï¼š

```
å‡è®¾æ£€ç´¢åˆ°èŠ‚ç‚¹Aï¼š"Pythonæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€"
èŠ‚ç‚¹Açš„é‚»å±…ï¼š
- èŠ‚ç‚¹Bï¼š"Pythoné€‚åˆæ•°æ®ç§‘å­¦"
- èŠ‚ç‚¹Cï¼š"Pythonæœ‰ä¸°å¯Œçš„åº“ç”Ÿæ€"

è¿”å›ç»“æœï¼š[A, B, C]
```

è¿™ç§è®¾è®¡è®©LLMèƒ½çœ‹åˆ°æ›´å®Œæ•´çš„çŸ¥è¯†å›¾è°±å±€éƒ¨ç»“æ„ã€‚

### è®°å¿†çš„æŒä¹…åŒ–ä¸æ¸…ç†

**æŒä¹…åŒ–**ï¼š
```python
memory_bank.export_memory("task_memory.json")
```
å°†å½“å‰çš„InsightDocã€QueryGraphã€InteractionTreeå…¨éƒ¨å¯¼å‡ºä¸ºJSONã€‚

**åŠ è½½**ï¼š
```python
memory_bank.load_memory("task_memory.json")
```
ä»JSONæ¢å¤å®Œæ•´çš„è®°å¿†çŠ¶æ€ã€‚

**è‡ªåŠ¨æ¸…ç†**ï¼š
æ¯æ¬¡ä»»åŠ¡å®Œæˆåï¼ˆç”¨æˆ·è¾“å…¥quitï¼‰ï¼Œç³»ç»Ÿä¼šè°ƒç”¨`clear_memory()`æ¸…ç©ºæ‰€æœ‰è®°å¿†ï¼Œç¡®ä¿ä¸‹æ¬¡ä»»åŠ¡ä»å¹²å‡€çŠ¶æ€å¼€å§‹ã€‚

### é”™è¯¯å¤„ç†æœºåˆ¶

**Agentè°ƒç”¨å¤±è´¥**ï¼š
- è®°å½•é”™è¯¯æ—¥å¿—
- é‡è¯•ä¸€æ¬¡
- å¦‚æœä»å¤±è´¥ï¼Œæ ‡è®°å½“å‰ä»»åŠ¡ä¸ºfailureï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡

**å·¥å…·è°ƒç”¨å¤±è´¥**ï¼š
- è®°å½•é”™è¯¯ä¿¡æ¯
- è¿”å›é”™è¯¯æ¶ˆæ¯ç»™ReAct Agent
- ç”±Agentå†³å®šå¦‚ä½•ç»§ç»­ï¼ˆå¯èƒ½æ¢ä¸€ä¸ªå·¥å…·æˆ–ç­–ç•¥ï¼‰

**å®‰å…¨ä¸Šé™**ï¼š
- `MAX_LLM_CALL_PER_RUN`ï¼šé˜²æ­¢æ— é™å¾ªç¯ï¼ˆé»˜è®¤60æ¬¡ï¼‰
- `MAX_CONTEXT_TOKENS`ï¼šé˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡ºï¼ˆé»˜è®¤128000ï¼‰
- `MAX_MERGE_DEPTH`ï¼šé˜²æ­¢é€’å½’åˆå¹¶è¿‡æ·±ï¼ˆé»˜è®¤3ï¼‰

## é…ç½®å‚æ•°

æ‰€æœ‰å‚æ•°é€šè¿‡`.env`æ–‡ä»¶é…ç½®ï¼š

```bash
# LLMæä¾›å•†é€‰æ‹©
LLM_PROVIDER=deepseek  # å¯é€‰ï¼šdeepseek, openai, local

# DeepSeeké…ç½®
DEEPSEEK_API_KEY=your-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat

# OpenAIé…ç½®
OPENAI_API_KEY=your-key-here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4

# æœ¬åœ°æ¨¡å‹é…ç½®
LOCAL_BASE_URL=http://127.0.0.1:6001/v1
LOCAL_MODEL=default

# LLMé€šç”¨å‚æ•°
LLM_TEMPERATURE=0.6
LLM_MAX_TOKENS=4096
LLM_TOP_P=0.95

# Embeddingé…ç½®
EMBEDDING_MODEL=all-MiniLM-L6-v2

# æ£€ç´¢é…ç½®
RETRIEVAL_K=5  # top-kå€™é€‰èŠ‚ç‚¹æ•°
RETRIEVAL_ALPHA=0.5  # æ··åˆæ£€ç´¢æƒé‡ï¼ˆ0-1ï¼‰

# åˆå¹¶é…ç½®
MAX_MERGE_DEPTH=3  # æœ€å¤§é€’å½’åˆå¹¶æ·±åº¦
REPORT_CONFLICTS_IN_CONTEXT_LOADING=True  # æ˜¯å¦åœ¨context-onlyæ¨¡å¼æŠ¥å‘Šå†²çª

# APIé…ç½®
SERPER_API_KEY=your-serper-key  # ç½‘ç»œæœç´¢API
JINA_API_KEY=your-jina-key  # ç½‘é¡µå†…å®¹æå–API

# ReActé…ç½®
MAX_LLM_CALL_PER_RUN=60  # å•æ¬¡ä»»åŠ¡æœ€å¤§LLMè°ƒç”¨æ¬¡æ•°
MAX_CONTEXT_TOKENS=128000  # æœ€å¤§ä¸Šä¸‹æ–‡tokenæ•°

# å­˜å‚¨è·¯å¾„
TEMP_DIR=data/temp  # ä¸´æ—¶ç›®å½•ï¼ˆå½“å‰æœªä½¿ç”¨ï¼‰
STORAGE_DIR=data/storage  # å­˜å‚¨ç›®å½•ï¼ˆå½“å‰æœªä½¿ç”¨ï¼‰

# Agentçª—å£å¤§å°ï¼ˆtokensï¼‰
CLASSIFICATION_AGENT_WINDOW=32000
STRUCTURE_AGENT_WINDOW=32000
ANALYSIS_AGENT_WINDOW=32000
INTEGRATION_AGENT_WINDOW=32000
PLANNING_AGENT_WINDOW=32000

# Agent LLMå‚æ•°
CLASSIFICATION_AGENT_TEMPERATURE=0.4
CLASSIFICATION_AGENT_TOP_P=0.9

STRUCTURE_AGENT_TEMPERATURE=0.1
STRUCTURE_AGENT_TOP_P=0.8

ANALYSIS_AGENT_TEMPERATURE=0.4
ANALYSIS_AGENT_TOP_P=0.9

INTEGRATION_AGENT_TEMPERATURE=0.2
INTEGRATION_AGENT_TOP_P=0.85

PLANNING_AGENT_TEMPERATURE=0.6
PLANNING_AGENT_TOP_P=0.95

REACT_AGENT_TEMPERATURE=0.6
REACT_AGENT_TOP_P=0.95

VISIT_EXTRACTION_TEMPERATURE=0.2  # Visitå·¥å…·å†…éƒ¨LLMæå–å‚æ•°
VISIT_EXTRACTION_TOP_P=0.85

# é•¿æ–‡æœ¬å¤„ç†
CHUNK_RATIO=0.9  # åˆ†å—æ—¶ä½¿ç”¨çª—å£çš„90%ï¼Œç•™10%ä½™é‡

# æ—¥å¿—
LOG_LEVEL=INFO
```

## å½“å‰å®ç°çš„é™åˆ¶ä¸æœªæ¥æ–¹å‘

### å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

âœ… ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼ˆInsightDocã€QueryGraphã€InteractionTreeï¼‰
âœ… å®Œæ•´çš„è®°å¿†æ›´æ–°æµç¨‹ï¼ˆåˆ†ç±»ã€ç»“æ„åŒ–ã€æ£€ç´¢ã€å…³ç³»åˆ¤æ–­ã€å»ºè¾¹ï¼‰
âœ… å†²çªæ£€æµ‹ä¸è§£å†³æœºåˆ¶
âœ… å¢é‡å¼è§„åˆ’ç­–ç•¥
âœ… æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯+è¯­ä¹‰+é‚»å±…æ‰©å±•ï¼‰
âœ… ReAct Agentï¼ˆæ”¯æŒsearchã€visitã€deep_retrievalå·¥å…·ï¼‰
âœ… è®°å¿†æŒä¹…åŒ–ï¼ˆJSONå¯¼å‡º/å¯¼å…¥ï¼‰
âœ… Context-onlyæ¨¡å¼ï¼ˆä»…åŠ è½½ä¸Šä¸‹æ–‡ï¼‰
âœ… å¤šLLMæä¾›å•†æ”¯æŒï¼ˆDeepSeekã€OpenAIã€Localï¼‰

### å½“å‰é™åˆ¶

âŒ **ä¸æ”¯æŒå¤šæ¨¡æ€å†…å®¹**ï¼šåŸå§‹è®¾è®¡åŒ…å«å›¾ç‰‡ã€PDFç­‰é™„ä»¶æ”¯æŒï¼Œä½†å½“å‰å®ç°ä¸ºçº¯æ–‡æœ¬ç³»ç»Ÿ
âŒ **Interaction Treeç»“æ„ç®€åŒ–**ï¼šé‡‡ç”¨æ‰å¹³çš„{node_id: text}æ˜ å°„ï¼Œä¸åŒºåˆ†çˆ¶å­èŠ‚ç‚¹å’Œé™„ä»¶
âŒ **ä¸´æ—¶å­˜å‚¨æœºåˆ¶æœªå®ç°**ï¼šTEMP_DIRå’ŒSTORAGE_DIRé…ç½®é¡¹å­˜åœ¨ä½†æœªä½¿ç”¨
âŒ **åˆå¹¶äº‹ä»¶è®°å½•ä¸å®Œæ•´**ï¼šå½“èŠ‚ç‚¹åˆå¹¶æ—¶ï¼ŒInteraction Treeåº”è¯¥è®°å½•åˆå¹¶äº‹ä»¶ï¼Œä½†å½“å‰å®ç°ä¸­ç¼ºå¤±è¿™éƒ¨åˆ†é€»è¾‘

### æœªæ¥ä¼˜åŒ–æ–¹å‘

**1. å¤šæ¨¡æ€æ”¯æŒ**
- å®ç°ä¸´æ—¶å­˜å‚¨æœºåˆ¶å¤„ç†ç”¨æˆ·ä¸Šä¼ 
- æ”¯æŒå›¾ç‰‡è¯†åˆ«ä»»åŠ¡
- å®Œå–„Interaction Treeçš„é™„ä»¶ç®¡ç†

**2. æ›´æ™ºèƒ½çš„Planning**
- å¯ä»¥å°è¯•ä½¿ç”¨å¼ºåŒ–å­¦ä¹ æˆ–ç›‘ç£å¾®è°ƒä¼˜åŒ–Planning Agent
- æ›´å¥½åœ°æƒè¡¡ä»»åŠ¡çš„ä¼˜å…ˆçº§

**3. å‘é‡æ•°æ®åº“é›†æˆ**
- å½“å‰embeddingå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥æ‰©å±•åˆ°Faissæˆ–Chroma
- æ”¯æŒæ›´å¤§è§„æ¨¡çš„è®°å¿†ç®¡ç†

**4. å†²çªè§£å†³ç­–ç•¥ä¼˜åŒ–**
- å¤„ç†éªŒè¯æ— æ³•å¾—å‡ºç»“è®ºçš„æƒ…å†µ
- å¤„ç†å¤šä¸ªèŠ‚ç‚¹éƒ½ä¸æ­£ç¡®çš„æƒ…å†µ
- æ›´ç»†ç²’åº¦çš„å†²çªæè¿°å’Œå®šä½

**5. è·¨ä»»åŠ¡è®°å¿†å¤ç”¨**
- å½“å‰æ¯æ¬¡ä»»åŠ¡å®Œæˆåæ¸…ç©ºè®°å¿†
- å¯ä»¥æ¢ç´¢é€‰æ‹©æ€§ä¿ç•™æœ‰ä»·å€¼çš„è®°å¿†åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡

## æŠ€æœ¯å®ç°è¦ç‚¹

### å›¾ç»“æ„çš„è½»é‡çº§å®ç°

ä½¿ç”¨çº¯Pythonå­—å…¸å’Œåˆ—è¡¨å®ç°é‚»æ¥è¡¨ï¼Œè€Œéä¾èµ–NetworkXï¼š

```python
class QueryGraph:
    def __init__(self):
        self.nodes_dict = {}  # {id: QueryGraphNode}

    # æ¯ä¸ªèŠ‚ç‚¹çš„linksåˆ—è¡¨ç»´æŠ¤é‚»å±…å…³ç³»
    # æ— å‘è¾¹éœ€è¦åŒå‘ç»´æŠ¤
```

**ä¼˜åŠ¿**ï¼š
- ç®€å•è½»é‡ï¼Œæ— é¢å¤–ä¾èµ–
- å¯¹äºæœ¬ç³»ç»Ÿçš„éœ€æ±‚è¶³å¤Ÿ
- ä¾¿äºåºåˆ—åŒ–å’ŒæŒä¹…åŒ–

### æ£€ç´¢ç´¢å¼•çš„æ‡’åŠ è½½

BM25ç´¢å¼•é‡‡ç”¨"è„æ ‡è®°+æ‡’é‡å»º"ç­–ç•¥ï¼š

```python
class RetrievalModule:
    def __init__(self):
        self._index_dirty = True
        self._bm25_index = None

    def mark_index_dirty(self):
        self._index_dirty = True

    def hybrid_retrieval(self, ...):
        if self._index_dirty:
            self._rebuild_index()
        # è¿›è¡Œæ£€ç´¢...
```

**ä¼˜åŠ¿**ï¼š
- é¿å…æ¯æ¬¡ä¿®æ”¹å›¾éƒ½é‡å»ºç´¢å¼•
- åªåœ¨éœ€è¦æ—¶é‡å»º
- æå‡æ•´ä½“æ•ˆç‡

### ReAct Agentçš„ä¸Šä¸‹æ–‡ç®¡ç†

æŒç»­è¿½è¸ªæ¶ˆæ¯å†å²çš„tokenæ•°ï¼š

```python
class MultiTurnReactAgent:
    def run(self, prompt):
        messages = [{"role": "system", "content": SYSTEM_PROMPT}]
        token_count = count_tokens(SYSTEM_PROMPT)

        for iteration in range(MAX_ITERATIONS):
            # æ£€æŸ¥æ˜¯å¦æ¥è¿‘ä¸Šé™
            if token_count > MAX_CONTEXT_TOKENS * 0.9:
                # æç¤ºLLMå°½å¿«ç»™å‡ºç­”æ¡ˆ
                messages.append({
                    "role": "user",
                    "content": "Context is nearly full. Please provide final answer now."
                })

            # è°ƒç”¨LLM...
```

### JSONè§£æçš„é²æ£’æ€§

Agentçš„LLMå“åº”å¯èƒ½æ ¼å¼ä¸å®Œç¾ï¼Œéœ€è¦é²æ£’çš„è§£æï¼š

```python
def _parse_json_response(self, response):
    # 1. å°è¯•ç›´æ¥è§£æ
    try:
        return json.loads(response)
    except:
        pass

    # 2. å°è¯•æå–```jsonä»£ç å—
    if "```json" in response:
        try:
            json_part = extract_code_block(response)
            json_part = fix_json_string(json_part)  # ä¿®å¤å¸¸è§é”™è¯¯
            return json.loads(json_part)
        except:
            pass

    # 3. å°è¯•æŸ¥æ‰¾JSONå¯¹è±¡
    start = response.find('{')
    end = response.rfind('}') + 1
    if start != -1 and end > start:
        try:
            json_str = response[start:end]
            json_str = fix_json_string(json_str)
            return json.loads(json_str)
        except:
            pass

    # 4. å¤±è´¥
    raise ValueError("Cannot parse JSON response")

def fix_json_string(json_str):
    # è¡¥å…¨ç¼ºå¤±çš„æ‹¬å·
    # ç§»é™¤æœ«å°¾å¤šä½™çš„é€—å·
    # ç­‰ç­‰...
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šé•¿æ–‡æ¡£ç†è§£

```bash
> Context: [ç²˜è´´ä¸€ä»½50é¡µçš„ç ”ç©¶æŠ¥å‘Š]
âœ… Context loaded successfully. You can now ask questions.

> è¿™ä»½æŠ¥å‘Šçš„æ ¸å¿ƒè®ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
[ç³»ç»Ÿä»è®°å¿†ä¸­æ£€ç´¢ç›¸å…³éƒ¨åˆ†ï¼ŒReAct Agentåˆ†æå¹¶å›ç­”]

> ç¬¬3ç« å’Œç¬¬7ç« çš„ç»“è®ºæ˜¯å¦ä¸€è‡´ï¼Ÿ
[ç³»ç»Ÿæ£€ç´¢ç¬¬3ç« å’Œç¬¬7ç« çš„è®°å¿†ï¼Œå¦‚æœå‘ç°çŸ›ç›¾ï¼Œè§¦å‘å†²çªéªŒè¯]
```

### ç¤ºä¾‹2ï¼šå¤šæºä¿¡æ¯éªŒè¯

```bash
> åŸƒè²å°”é“å¡”çš„é«˜åº¦æ˜¯å¤šå°‘ï¼Ÿ
[ReActæœç´¢å¹¶æ‰¾åˆ°ï¼š324ç±³]

> Context: æ ¹æ®æœ€æ–°èµ„æ–™ï¼ŒåŸƒè²å°”é“å¡”é«˜330ç±³
[ç³»ç»Ÿæ£€æµ‹åˆ°å†²çªï¼ŒPlanning Agentè§„åˆ’éªŒè¯ä»»åŠ¡]
[ReActæœç´¢æƒå¨æ¥æºè¿›è¡ŒéªŒè¯]
[Integration Agentæ•´åˆï¼šæœ¬ä½“324ç±³ï¼ŒåŒ…å«å¤©çº¿330ç±³]

> åŸƒè²å°”é“å¡”çš„é«˜åº¦æ˜¯å¤šå°‘ï¼Ÿ
[è¿”å›æ•´åˆåçš„å‡†ç¡®ä¿¡æ¯]
```

### ç¤ºä¾‹3ï¼šå¤æ‚å¤šæ­¥ç ”ç©¶

```bash
> è°ƒæŸ¥Pythonåœ¨æ•°æ®ç§‘å­¦é¢†åŸŸçš„åº”ç”¨æƒ…å†µ
[Planning: ç¬¬1æ­¥ - äº†è§£Pythonåœ¨æ•°æ®ç§‘å­¦çš„ä¼˜åŠ¿]
[ReAct: æœç´¢ç›¸å…³èµ„æ–™ï¼Œå·¥å…·è°ƒç”¨å¤šæ¬¡]
[è®°å¿†æ›´æ–°ï¼šåˆ›å»ºèŠ‚ç‚¹"Pythonæ•°æ®ç§‘å­¦ä¼˜åŠ¿"]

[Planning: ç¬¬2æ­¥ - æ‰¾åˆ°ä¸»æµçš„æ•°æ®ç§‘å­¦åº“]
[ReAct: æœç´¢NumPyã€Pandasã€Scikit-learnç­‰]
[è®°å¿†æ›´æ–°ï¼šåˆ›å»ºèŠ‚ç‚¹"Pythonæ•°æ®ç§‘å­¦åº“"]

[Planning: ç¬¬3æ­¥ - æ€»ç»“åº”ç”¨åœºæ™¯]
[ReAct: ç»¼åˆä¹‹å‰çš„è®°å¿†ç”Ÿæˆæ€»ç»“]
[ä»»åŠ¡å®Œæˆ]
```

### ç¤ºä¾‹4ï¼šè®°å¿†æŒä¹…åŒ–

```bash
> Context: [å¤§é‡ä¸Šä¸‹æ–‡]
> [é—®ä¸€äº›é—®é¢˜]
> export my_research.json
ğŸ’¾ Exported to: my_research.json
> quit

# ä¸‹æ¬¡å¯åŠ¨
> python main.py --load my_research.json
ğŸ“¥ Loaded memory from: my_research.json
> [ç»§ç»­ä¹‹å‰çš„è¯é¢˜]
```

## æ€»ç»“

Agentic Memory Bankæ˜¯ä¸€ä¸ªä¸“æ³¨äºå•æ¬¡ä»»åŠ¡çš„é•¿ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿã€‚é€šè¿‡ä¸‰å±‚å­˜å‚¨æ¶æ„ã€å¤šä¸ªä¸“ä¸šåŒ–Agentå’Œå¢é‡å¼è§„åˆ’ç­–ç•¥ï¼Œç³»ç»Ÿèƒ½å¤Ÿæœ‰æ•ˆå¤„ç†è¶…é•¿æ–‡æœ¬ã€å¤æ‚æ¨ç†ä»»åŠ¡å’ŒçŸ›ç›¾ä¿¡æ¯ã€‚å†²çªæ£€æµ‹ä¸è§£å†³æœºåˆ¶ç¡®ä¿äº†è®°å¿†çš„å¯ä¿¡åº¦ï¼Œæ··åˆæ£€ç´¢ç­–ç•¥æä¾›äº†çµæ´»é«˜æ•ˆçš„ä¿¡æ¯è·å–èƒ½åŠ›ã€‚

å½“å‰å®ç°èšç„¦äºæ ¸å¿ƒåŠŸèƒ½ï¼Œé‡‡ç”¨çº¯æ–‡æœ¬å­˜å‚¨å’Œè½»é‡çº§å›¾ç»“æ„ï¼Œä¸ºåŸºç¡€çš„é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡æä¾›å¯é æ”¯æŒã€‚æœªæ¥å¯ä»¥åœ¨å¤šæ¨¡æ€æ”¯æŒã€æ›´æ™ºèƒ½çš„è§„åˆ’å’Œè·¨ä»»åŠ¡è®°å¿†å¤ç”¨ç­‰æ–¹å‘è¿›ä¸€æ­¥å‘å±•ã€‚
