# Agentic Memory Bank: 面向任务的长上下文管理的层级化图结构多智能体系统

## 系统概述

### 设计目标

Agentic Memory Bank 是一个由多个专门化智能体管理的层级化图结构系统，旨在处理面向任务的长上下文场景。该系统提供了一种可以集成到不同外部 Agent 框架的记忆管理范式。系统专门设计用于解决单次任务的长上下文问题，而非构建从不断增长的记忆中持续学习的个性化长期记忆智能体。每次任务完成后，所有记忆都会被清理。

### 应用场景

系统面向三种长上下文场景：

**深度研究**：需要交叉引用权威来源和解决冲突信息的多源信息检索、验证和综合分析。

**长文档问答**：理解和回答超过典型 LLM 上下文窗口的长文档相关问题。

**多轮对话推理**：跨越涉及复杂推理链和工具使用的扩展对话的上下文管理。

## 存储架构

系统采用三层存储结构来管理长上下文信息。

### Insight Doc 层

Insight Doc 层以简洁的结构化形式管理任务执行状态，作为传递给外部框架的默认上下文，随着任务进展增量更新。

**核心组成部分**：

任务目标存储用户的原始问题或任务描述。已完成任务列表维护已完成子任务的记录，每条记录包含任务类型、详细描述、执行状态和知识上下文的四元组。每种任务类型要么是由 Planning Agent 规划的常规子任务的 NORMAL 类型，要么是在检测到矛盾信息时触发的冲突解决任务的 CROSS_VALIDATE 类型。知识上下文是一到两句话的浓缩总结，包含成功执行后检索到的信息或推导出的见解。

当前任务字段采用增量式规划策略，存储空字符串表示没有待办任务，或存储单个任务字符串表示下一步。这种设计消除了对优先级队列或复杂任务排序机制的需求，允许 Planning Agent 仅根据当前进度决定下一步，而不是一次性规划所有步骤。这种方法能够动态适应执行结果并立即响应冲突。

**增量式规划理念**：

系统使用单步规划模式，Planning Agent 仅决定下一步行动而不是预先创建全面计划。这种设计提供基于每步结果的动态适应、无需维护优先级队列的降低复杂性，以及通过在检测到矛盾时将 Cross Validation 任务作为下一步的即时冲突响应。当前任务字段在大多数时候通常包含零个或一个任务。

### Query Graph 层

Query Graph 以图结构存储结构化的记忆摘要，支持高效的粗粒度检索。

**节点粒度**：

一个 Query Graph 节点对应经过 Structure Agent 处理的主题聚类内容。在整理子任务的记忆时，Classification Agent 决定如何将子任务的上下文拆分或组合成主题类别。

**节点属性**：

每个节点包含唯一标识符、包含关键信息和证据的结构化详细摘要、作为上下文的简短一句话主题描述、用于基于属性检索的关键词列表、存储在内存中用于相似度检索可扩展到向量数据库存储的语义向量 embedding，以及创建时间戳。

**关系和边**：

严格来说，Query Graph 只有一种边类型：related 边，表示节点之间的语义、主题或逻辑关联，为无向边。节点之间可能存在特殊的关系状态，由 Memory Analysis Agent 确定而非边类型。conflict 状态表示内容相互矛盾触发 Cross Validation 工作流。related 状态表示语义、主题或逻辑关联建立 related 边。

**关系判断优先级**：

系统使用优先级机制进行关系确定，conflict 优先于 related。工作流首先检查内容矛盾的 conflict 关系，然后如果不存在 conflict 则检查 related 关系。检测到冲突后，系统立即通过 Cross Validation 执行相应处理，节点最终被验证和合并。

**检索方法**：

基于属性的检索使用关键词匹配。基于 embedding 的检索使用语义向量相似度。混合检索结合两者，使用可配置的 alpha 参数计算最终分数，公式为 alpha 乘以基于属性的分数加上一减 alpha 乘以基于 embedding 的分数。

**检索流程**：

筛选阶段使用相似度或混合分数选择 top-k 个候选节点。扩展阶段为每个候选节点附加完整属性的一跳邻居节点。排序阶段在返回结果前按时间戳降序排列所有节点，包括候选节点和邻居节点。

top-k 值 k 是需要初始化的可配置参数，通常范围从 5 到 10。

### Interaction Tree 层

Interaction Tree 以只读的树结构存储细粒度的原始交互数据，支持多模态信息。树既不修改历史内容也不重写原始记录。当 Query Graph 节点合并时，系统只是将原始节点的 Interaction Tree 重新附加到合并后的新节点，并添加只读的合并事件元数据条目，解释哪些节点何时合并，便于上下文来源追溯。

**结构特征**：

每个 Query Graph 节点对应一个或多个 Interaction Tree。父节点存储完整的上下文文本，包括推理过程、工具调用和结果摘要。子节点存储来自用户上传或工具返回的多模态附件。

**多模态附件设计**：

多模态内容来自用户上传。当用户上传图片时，Adapter 首先将其保存到临时存储，等待外部框架完成识别任务，然后正式创建包含识别结果文本作为父节点和图片附件作为子节点的 Interaction Tree 节点。

附件类型包括图片、PDF 原文等文档，以及代码片段和执行结果等代码。子节点属性包括父节点文本中引用的唯一标识符、指示图片、文档或代码类别的多模态类型，以及存储磁盘位置或云存储 URI 的文件路径而非文件内容本身。

**存储策略**：

系统有选择性地保留相关的重要多模态内容而非全部。通过文件路径索引访问实际文件，避免在节点属性中存储大量二进制数据或文本内容，提高存储效率和系统性能。

**存储实现**：

所有记忆包括 Query Graph 和 Interaction Tree 都存储在内存中。可选功能提供简单的持久化接口，将当前记忆导出为 JSON 文件。单次任务完成后所有内存中的记忆都会被清理。

## 组件设计

### 硬编码功能模块

这些功能通过程序逻辑实现，不涉及 LLM 调用。

**Embedding 计算模块**：

该模块为文本内容生成语义向量。接受包括摘要和上下文的文本输入，产生 embedding 向量作为输出，调用如使用 all-MiniLM-L6-v2 模型的 sentence transformers 等 embedding API。对于存储，初始方法直接将 embedding 存储在内存中的 Query Graph 节点 embedding 属性中，可扩展选项是存储在如 Faiss 或 Chroma 的向量数据库中，节点仅保留 embedding ID 索引。

**检索模块**：

该模块基于 embedding 相似度执行候选节点检索。接受新节点 embedding 和包括 k 值和检索方法的检索参数作为输入，返回包含完整信息的 top-k 候选节点列表，包括标识符、摘要、上下文、关键词和时间戳。实现计算余弦相似度，可选地结合关键词匹配进行混合检索，返回 top-k 结果加上每个节点的一跳邻居。

可配置的检索参数包括用于 top-k 检索的 k，需要初始化通常范围从 5 到 10，以及作为混合检索权重系数的 alpha，计算最终分数为 alpha 乘以基于属性的加上一减 alpha 乘以基于 embedding 的，也需要初始化通常范围从 0.3 到 0.7。

**图操作模块**：

该模块管理 Query Graph 的边和节点。功能包括创建节点、删除节点、创建 related 边、删除边、查询节点邻居，以及更新包括上下文、关键词和 embedding 的节点属性。实现使用基于字典的节点存储的自定义邻接表结构。

### Agent 功能模块

这些功能使用 LLM 进行智能判断和生成。

**Classification Agent**：

该智能体对长上下文执行基于主题的分类或聚类，为每个类别生成上下文和关键词描述。其目的是避免一次处理过长的上下文，在传递给 Structure Agent 之前进行分块。

输入包括可能超过智能体窗口长度的长上下文文本，以及可选的当前任务描述以辅助分类决策。输出包括指示是否需要聚类的聚类判断布尔值，如果需要聚类则包括聚类列表，其中每个聚类包含唯一标识符、作为上下文的简短一句话主题描述、属于该主题的原始文本内容，以及关键词列表。

**处理过长上下文**：

当输入上下文超过智能体窗口长度时，系统使用分块策略。计算块大小为智能体窗口大小乘以可配置比率，通常约为 0.9 留 10% 余量。在段落或章节边界处将上下文拆分为块。每个块独立处理生成聚类。所有聚类直接传递给 Structure Agent 处理。

**分类标准**：

通常按主题分类。用户输入的原始问题应单独提取作为任务目标存储在 Insight Doc 中。

**Structure Agent**：

该智能体对分类后的单个主题内容执行结构化压缩，生成摘要抽象。输入包括单个聚类内容以及聚类上下文和关键词供参考。输出是包含关键信息、证据和逻辑的结构化详细摘要。

**后续硬编码处理**：

生成节点标识符为 UUID 或递增 ID。复制 Classification Agent 提供的上下文和关键词。读取当前时间戳。调用 Embedding 计算模块为摘要生成 embedding。组装完整节点并存储在 Query Graph 中。

**优势**：

一次只处理一个主题分类的上下文避免窗口溢出。

**Memory Analysis Agent**：

该智能体判断新节点和现有节点之间的关系，在可能的情况下通过单次 LLM 调用完成优先级排序的确定。工作流默认触发一次 LLM 调用，按顺序检查每个候选节点是否存在冲突然后是否有 related 关系，在命中任何关系后立即返回而不继续后续判断。顺序判断确保冲突关系优先处理，同时避免不必要的重复调用。

输入包括带有摘要、上下文和关键词但明确排除 embedding 的新节点，以及检索模块返回的类似结构不包含 embedding 的候选节点列表。输出是关系列表，其中每个关系包含现有节点标识符、作为 conflict、related 或 unrelated 的关系类型，以及解释判断的推理。对于 conflict 关系，输出包括冲突描述。对于 related 关系，输出包括新节点和现有节点的更新上下文和关键词列表。

**关系类型定义**：

Unrelated 表示节点之间没有语义、主题或逻辑关联。Related 表示语义、主题或逻辑关联建立 related 边。Conflict 表示内容相互矛盾触发 Cross Validation 工作流。

**判断标准**：

智能体基于 prompt 规则自主判断，返回结构化输出。

**后续硬编码处理**：

对于 related 关系，调用图操作模块创建 related 边。对于冲突，标记冲突状态并传递给 Planning Agent。

**Memory Integration Agent**：

该智能体基于多个节点生成整合后的新节点内容。当 Memory Analysis Agent 判断需要在 Cross Validation 后合并的冲突关系时触发。

输入包括要合并的节点列表及其标识符、摘要、上下文和关键词，每个节点的邻居列表及其标识符、上下文和关键词，以及外部框架返回的验证结果。输出包括合并节点内容，包含整合的详细摘要、综合的主题描述、整合的关键词列表，以及解释合并操作的 Interaction Tree 描述。

**后续硬编码处理**：

生成新节点标识符和时间戳。基于摘要、上下文和关键词计算新节点 embedding。继承所有要合并节点的边，去重确保如果多个节点共享公共邻居只保留一条边。基于 Interaction Tree 描述在 Interaction Tree 中记录合并操作。删除所有合并的节点及其边。

**合并策略规则**：

通过 prompt 预定义，包括基于时间戳保留更新的信息，综合所有节点的优势补充缺失信息，以及使用验证结果作为权威。

**Planning Agent**：

该智能体分析任务目标和记忆以制定和更新计划。输入包括 Insight Doc 任务状态层、新添加的带有摘要、上下文和关键词的 Query Graph 记忆节点，以及可选的冲突通知。输出是更新的 Insight Doc，包含任务目标描述、已完成子任务列表（每个子任务包括类型、描述、状态和上下文），以及当前任务字段。

**策略**：

增量式规划，每次迭代仅决定下一步，参考完整历史而不重新规划所有内容。动态调整，基于新记忆和任务执行结果灵活修改当前任务。冲突响应，在检测到冲突关系时规划 Cross Validation 任务作为下一步。

**终止判断**：

如果当前任务为空且所有子任务状态为成功，系统终止。否则继续执行。任务终止完全由 Planning Agent 自主判断，没有硬性的最大迭代限制，尽管系统有一个安全的最大迭代计数以防止无限循环。

**可选优化**：

使用经过监督微调或强化学习的专门模型。

### 系统接口模块

**Adapter**：

Adapter 作为 Agentic Memory Bank 和外部框架之间的接口层，负责上下文拦截、增强和传输，以及多模态内容的临时管理。

**设计定位**：

Agentic Memory Bank 提供记忆管理范式，外部智能体框架如 ReAct 通过 Adapter 交互以实现结构化的长上下文管理。

**标记格式规范**：

为了提高系统的可解析性和与 ReAct 框架的兼容性，系统定义了标记模式。Task 标签包装 Insight Doc 内容。Memory 标签包装 Query Graph 记忆节点。Tool call 和 tool response 标签表示 Deep Retrieval 工具调用和响应。

**功能一：多模态内容临时管理**：

当用户上传如图片的多模态内容时，Adapter 处理临时存储和管理。临时存储工作流将上传的图片保存到临时目录，使用 Insight Doc 文档标识符作为键在内部维护临时存储映射，存储图片临时路径和类型信息而不立即创建 Interaction Tree 节点，等待 Planning Agent 识别待处理的多模态内容并规划识别任务。

识别完成处理后，外部框架执行图片识别任务返回结果。Adapter 从临时存储提取图片信息，将图片从临时目录移动到正式存储目录，与识别结果一起创建完整的 Interaction Tree 节点，包括文本描述和图片附件，清理临时存储映射。

**设计理由**：

避免在识别前创建不完整的记忆节点。通过同时保存文本描述和附件确保数据完整性。避免污染持久化数据，因为临时状态不会被序列化。遵循完整的正常记忆创建工作流。

**功能二：Prompt 增强**：

增强工作流发生在初始化和每个执行循环开始时。步骤包括读取 Insight Doc 以获取当前任务和执行状态，调用检索模块为当前任务从 Query Graph 检索相关记忆，使用结合 alpha 乘以基于属性的加上一减 alpha 乘以基于 embedding 的分数的混合检索，返回 top-k 节点加上每个节点的一跳邻居按时间戳降序排序，检查临时存储的多模态内容，如果存在待识别的图片则从临时存储读取并附加到 prompt，使用 task 标签包装完整的 Insight Doc 内容、memory 标签包装检索到的相关 Query Graph 记忆（包括摘要、上下文和关键词）以及适合外部框架格式的多模态内容（如 base64 编码的图片）组装增强 prompt，然后传递给外部框架。

**功能三：上下文拦截**：

拦截工作流发生在每个执行循环结束时。步骤包括外部框架完成当前任务输出停止 token，Adapter 拦截任务执行上下文，并判断任务类型。如果是 Cross Validation 任务，直接传递给 Memory Integration Agent 进行冲突处理。如果是图片识别任务，从临时存储提取图片，移动到正式目录，与识别结果一起创建记忆节点，清理临时存储。如果是普通任务，传递给 Classification Agent 开始记忆更新工作流。

**错误处理**：

当智能体调用失败时，记录错误并重试一次。如果连续失败，将当前任务标记为失败并继续执行。任务终止时自动清理临时存储的多模态文件。

**Deep Retrieval 工具**：

该工具由外部框架调用，读取特定 Query Graph 记忆的完整 Interaction Tree 内容，包括所有条目文本和实际附件内容。工具在 ReAct 框架初始化期间声明，作为整个执行过程中可用的标准工具集的一部分。

输入是 Query Graph 节点标识符。输出包括按时间戳排序的所有 Interaction Tree 条目完整信息，其中每个条目包含唯一条目标识符、完整文本内容、创建时间戳、包括来源和工具调用的元数据信息，以及附件列表，其中每个附件包含唯一标识符、指示图片、文档或代码类别的附件类型、文件路径内容，以及按类型处理的实际文件内容，图片返回 base64 编码，文档返回解析的文本或 base64，代码返回原始文本。

**使用场景**：

外部框架发现 Query Graph 摘要不够详细需要查看原始推理过程。需要访问如图片和 PDF 等多模态附件的完整内容。需要理解详细的工具调用历史和执行过程。

**设计理由**：

一次返回所有信息简化调用工作流。条目文本已包含摘要，附件根据需要使用。外部框架自主决定是否使用附件内容。

**调用格式**：

使用 ReAct 标准的 tool call 和 tool response 标记。

**ReAct Agent**：

该智能体是实现 Think-Act-Observe 循环和工具调用能力的多轮对话智能体。接收可能由 Adapter 增强的任务描述，执行推理和工具调用循环，返回最终答案或执行结果。

**核心工作流**：

智能体维护包括系统 prompt、用户输入和助手响应的消息历史。在每次迭代中，调用 LLM 生成可能包含用于推理过程的 think 标签、用于工具调用的 tool call 标签或用于最终答案的 answer 标签的响应。如果检测到工具调用，智能体提取工具名称和参数，执行包括 search、visit 或 deep retrieval 的相应工具，将结果格式化为 tool response，并添加到消息历史。循环继续直到出现 answer 标签、达到最大迭代次数或超过 token 限制。

**工具支持**：

Search 工具使用需要有效 API 密钥的 Serper API 执行网络搜索。Visit 工具使用 Jina Reader API 获取和提取网页内容。Deep retrieval 工具读取 Query Graph 节点的完整 Interaction Tree 内容。

**上下文管理**：

智能体跟踪消息历史中的总 token 计数。当接近最大上下文 token 限制时，智能体请求立即最终答案。如果超过限制，智能体强制生成答案并终止。

**终止条件**：

当助手响应包含 answer 标签时找到答案。在用尽允许的迭代次数后达到最大迭代次数。当上下文长度超过最大阈值时超过 token 限制。当 LLM 调用或工具执行严重失败时发生错误。

## 数据流

### 初始化阶段

用户输入包含可能包括上下文、问题和如图片等多模态内容的 prompt。Adapter 拦截输入，捕获用户输入，如果用户上传图片或其他多模态内容，保存到临时目录并在内部维护临时存储映射，等待后续识别任务完成后再正式创建记忆节点。

系统判断是否需要处理文本上下文。如果存在文本上下文，进行分类。如果不存在文本上下文仅有问题或图片，跳到规划。

Classification Agent 对上下文执行分类。如果过长，采用 90% 窗口容量的分块。生成聚类列表，其中每个聚类包括上下文和关键词。

Structure Agent 为每个聚类生成摘要，产生结构化抽象。

硬编码处理通过生成节点标识符、复制上下文和关键词、生成时间戳、调用 Embedding 计算模块为摘要生成 embedding、组装包含标识符、摘要、上下文、关键词、embedding 和时间戳的完整节点并存储在内存中来组装完整节点并存储。

硬编码检索调用检索模块基于新节点 embedding 检索 top-k 候选节点。

Memory Analysis Agent 分两个阶段判断关系。第一阶段优先判断冲突，输入为包括摘要、上下文和关键词的新节点加上类似结构的候选节点列表。批量判断确定新节点是否与候选节点有冲突关系。处理结果显示如果存在冲突，标记冲突关系并跳到规划，Planning Agent 将规划 Cross Validation 任务作为下一步。如果不存在冲突，进入第二阶段。

第二阶段通过批量判断新节点与候选节点的 related 关系来判断 related 关系。硬编码处理创建 related 边。

硬编码处理创建 Interaction Tree，父节点存储完整的原始上下文文本，子节点如果存在则选择性地存储如图片和 PDF 的多模态内容。

Planning Agent 分析任务，输入为任务目标加上包括摘要、上下文和关键词的新生成的 Query Graph 节点或冲突通知。如果 Adapter 有临时存储的多模态内容，Planning Agent 可以识别待处理的图片或其他内容。输出更新 Insight Doc，包括任务目标、已完成的子任务（如果有）和当前任务列表，决定下一步如规划图片识别任务。

Adapter 通过读取 Insight Doc、通过硬编码逻辑调用检索模块为当前任务检索相关 Query Graph 记忆（使用混合检索返回 top-k 结果加上一跳邻居按时间戳降序排序）、检查临时存储的多模态内容如果存在则以适合外部框架的格式附加（如 base64 编码的图片）、使用 task 标签包装 Insight Doc 加上 memory 标签包装相关记忆加上多模态内容组装并传递给外部框架来增强 prompt。

### 执行循环

外部框架基于 Insight Doc 当前任务执行，参考提供的 Query Graph 记忆，必要时调用 Deep Retrieval 工具查看完整的 Interaction Tree 内容，完成任务输出停止 token。

Adapter 拦截上下文，捕获外部框架执行上下文。

任务类型判断分为三个路径。

**路径一：冲突解决的 Cross Validation 任务**：

外部框架完成多源信息验证返回验证结果。直接传递给 Memory Integration Agent。Memory Integration Agent 基于冲突触发和验证结果生成整合的新节点。硬编码处理基于摘要、上下文和关键词计算新节点 embedding，去重继承所有冲突节点的边，更新所有邻居节点的上下文、关键词和 embedding，在 Interaction Tree 中记录合并操作，删除所有冲突节点及其边。新节点递归进入检索，排除已知邻居作为继承的边，判断与新候选节点的关系，如果存在更多冲突则递归处理直到只剩 related 关系。

**路径二：图片识别任务**：

外部框架完成图片识别返回文本描述。Adapter 从临时存储提取图片信息，将图片从临时目录移动到正式存储目录，与识别结果一起创建完整的 Interaction Tree 节点，包括文本描述父节点和存储类型为图片、内容为正式文件路径的图片附件子节点。通过 Structure Agent、硬编码 embedding 计算、硬编码检索和 Memory Analysis Agent 过程执行分类。清理临时存储映射。更新 Query Graph 和 Interaction Tree。

**路径三：普通任务**：

通过 Structure Agent、硬编码 embedding 计算、硬编码检索、Memory Analysis Agent 两阶段处理和硬编码 Interaction Tree 创建执行分类。更新 Query Graph 和 Interaction Tree。

Planning Agent 通过将刚完成的任务添加到已完成子任务列表、基于新记忆决定下一个任务和更新当前任务字段来更新 Insight Doc。

终止判断检查当前任务是否为空表示任务完成和系统终止。否则返回 Adapter prompt 增强进行下一轮。

### 冲突处理机制

此机制提高系统的可信度。

**触发条件**：

Memory Analysis Agent 在第一阶段判断期间检测到冲突关系。

**处理工作流**：

通过记录冲突关系状态而不建立特殊边并临时将新节点添加到 Memory Bank 等待验证来标记冲突。

规划验证任务，Planning Agent 分析冲突记忆并规划 Cross Validation 任务作为下一步，任务类型为 Cross Validation，任务描述验证特定节点之间的冲突并解释冲突点，执行方法调用 search 或其他工具检索多源信息进行交叉验证。

外部框架在下一循环迭代中执行验证，搜索权威来源，比较多个信息源，得出确定正确性或整合方法的验证结论。

解决冲突，Adapter 拦截验证结果，识别为 Cross Validation 任务，直接传递给 Memory Integration Agent，后者基于冲突触发和验证结果生成整合的新节点。硬编码处理删除冲突节点，创建新节点，继承边，更新邻居，生成新的整合节点继续正常工作流。

**边界情况处理**：

当前版本不处理验证无法得出明确结论或两个节点都不正确的情况。这些情况将在未来版本中得到支持。

## 系统特性

### 增量式规划理念

系统采用单步规划模式，Planning Agent 仅决定下一步而非全面计划。这提供对执行结果的动态适应、无需优先级队列的降低复杂性和即时冲突响应。当前任务字段通常包含零个或一个任务。

### 可信度的冲突解决

当检测到矛盾信息时，系统不立即接受或忽略，而是触发 Cross Validation 工作流，外部框架搜索权威来源进行验证。Memory Integration Agent 综合验证结果生成整合节点，确保记忆可靠性。

### 多模态支持

系统通过临时存储机制支持用户上传的图片和其他多模态内容。Adapter 将多模态内容保存到临时目录，等待外部框架完成识别，然后与识别结果和实际内容一起正式创建记忆节点。这种设计确保数据完整性并遵循正常的记忆创建工作流。

### 混合检索策略

系统结合基于属性的关键词匹配和基于 embedding 的语义相似度。可配置的 alpha 参数平衡两种检索方法，适应不同场景需求。检索结果不仅包括 top-k 候选节点，还包括一跳邻居，提供更丰富的上下文信息。

### 记忆持久化和清理

所有记忆在任务执行期间存储在内存中。系统提供可选的 JSON 导出功能用于持久化。任务完成后，所有记忆自动清理，确保下一个任务的干净状态。

### 灵活的 LLM 配置

系统支持多个 LLM 提供商，包括 DeepSeek、OpenAI 和本地模型。每个智能体可以独立配置 temperature 和 top-p 参数，针对不同任务特征进行优化。Classification 和 Analysis Agent 使用约 0.4 的适中温度以平衡创造性和准确性。Structure 和 Integration Agent 使用约 0.1 到 0.2 的低温度以获得精确的确定性输出。Planning 和 ReAct Agent 使用约 0.6 的较高温度以进行灵活的创造性规划。

### 可扩展架构

系统设计为可以集成到不同外部智能体框架的记忆管理范式。核心记忆管理逻辑独立于特定执行框架。外部框架通过 Adapter 接口交互。模块化设计允许独立替换或升级单个组件。

## 配置参数

所有系统参数都可以通过环境变量配置。

**LLM 提供商配置**：在 DeepSeek、OpenAI 或本地模型之间选择，分别具有各自的 API 密钥、base URL 和模型名称。通用 LLM 参数包括默认为 0.6 的 temperature、默认为 4096 的最大 token 数和默认为 0.95 的 top-p。

**Embedding 配置**：指定默认为 all-MiniLM-L6-v2 的 embedding 模型。

**检索配置**：设置默认为 5 的 top-k 值和默认为 0.5 的 alpha 混合权重。

**外部 API 配置**：提供用于网络搜索的 Serper API 密钥和用于网页内容提取的 Jina API 密钥。

**ReAct 配置**：定义默认为 60 的每次运行最大 LLM 调用次数和默认为 128000 的最大上下文 token 数。

**存储路径配置**：指定用于多模态临时存储的临时目录和用于正式多模态内容存储的存储目录。

**Agent 窗口配置**：为每个智能体设置上下文窗口大小，包括 Classification、Structure、Analysis、Integration 和 Planning Agent，都默认为 32000 个 token。

**Agent LLM 参数配置**：为每个智能体单独配置 temperature 和 top-p。Classification Agent 使用 0.4 温度和 0.9 top-p。Structure Agent 使用 0.1 温度和 0.8 top-p。Analysis Agent 使用 0.4 温度和 0.9 top-p。Integration Agent 使用 0.2 温度和 0.85 top-p。Planning Agent 使用 0.6 温度和 0.95 top-p。ReAct Agent 使用 0.6 温度和 0.95 top-p。

**长文本处理配置**：设置用于拆分过长上下文的块比率，默认为 0.9 留 10% 余量。

## 技术实现细节

### 图结构实现

Query Graph 使用自定义邻接表实现而非 NetworkX。节点存储在将标识符映射到节点对象的字典中。每个节点维护邻居标识符列表。这种轻量级实现为系统需求提供足够的功能，同时保持简单性和控制。

### 检索索引管理

检索模块维护用于基于关键词检索的 BM25 索引。索引在包括添加节点、删除节点或更新节点属性的图修改后被标记为脏。脏索引在下次检索操作期间自动重建。这种惰性重建策略避免不必要的重新计算，提高整体效率。

### Token 计数和上下文管理

ReAct Agent 持续监控消息历史 token 计数。当接近最大上下文 token 限制时，智能体请求立即最终答案。这种主动管理防止对话中途截断，确保顺利执行。

### 错误处理和重试逻辑

智能体调用失败触发错误记录和单次重试尝试。连续失败将当前任务标记为失败允许执行继续。这种弹性设计防止单个组件失败导致整个系统崩溃。

### Interaction Tree 合并处理

当 Query Graph 节点合并时，原始节点的 Interaction Tree 重新附加到新合并的节点。系统添加只读的合并事件元数据条目，记录哪些节点何时合并并附带描述。这种设计保留完整的历史信息，实现完整的上下文追溯，而不复制或修改原始条目。
